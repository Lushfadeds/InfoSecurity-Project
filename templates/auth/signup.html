{% extends "base.html" %}

{% block title %}Sign Up - PinkHealth{% endblock %}
{% block navbar %}{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4">
  <div class="flex items-center gap-2 mb-8">
    <div class="w-12 h-12 bg-pink-500 rounded-xl flex items-center justify-center shadow-sm">
      <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </div>
    <span class="text-pink-500 text-3xl font-semibold tracking-tight">PinkHealth</span>
  </div>

  <div class="w-full max-w-2xl bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-gray-100 p-10">
    <h1 class="text-2xl font-semibold text-gray-800 text-center mb-2">Create Patient Account</h1>
    <p class="text-blue-900/50 text-center font-medium mb-10">Join PinkHealth for secure access to your medical records</p>

    <div class="flex items-center justify-center mb-12">
      <div class="flex items-center gap-3">
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-pink-500 text-white font-medium" data-step="1">
          <span id="step1-text">1</span>
          <svg id="step1-check" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <span class="text-sm text-gray-500 font-medium">Personal Info</span>
      </div>
      <div id="line1" class="w-16 h-[2px] mx-2 bg-gray-200"></div>
      <div class="flex items-center gap-3">
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-gray-200 text-gray-400 font-medium" data-step="2">
          <span id="step2-text">2</span>
          <svg id="step2-check" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <span class="text-sm text-gray-500 font-medium">Account Details</span>
      </div>
      <div id="line2" class="w-16 h-[2px] mx-2 bg-gray-200"></div>
      <div class="flex items-center gap-3">
        <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-gray-200 text-gray-400 font-medium" data-step="3">
          <span>3</span>
        </div>
        <span class="text-sm text-gray-500 font-medium">Verification</span>
      </div>
    </div>

    <form id="signupForm" class="space-y-6 max-w-lg mx-auto">
      <div id="step1Form" class="space-y-6">
        <div>
          <label class="block text-gray-600 font-medium mb-2">Full Name (as per NRIC) *</label>
          <input type="text" name="fullName" placeholder="John Doe" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
        </div>
        <div>
          <label class="block text-gray-600 font-medium mb-2">NRIC / FIN *</label>
          <input type="text" name="nric" placeholder="S1234567A" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
          <p class="text-xs text-gray-400 mt-2 font-medium">Your NRIC will be encrypted and masked after registration</p>
        </div>
        <div>
          <label class="block text-gray-600 font-medium mb-2">Mobile Number *</label>
          <input type="tel" name="phone" placeholder="12345678" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
        </div>
      </div>

      <div id="step2Form" class="space-y-6 hidden">
        <div>
          <label class="block text-gray-600 font-medium mb-2">Email Address *</label>
          <input type="email" name="email" placeholder="your@email.com" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
        </div>
        <div>
          <label class="block text-gray-600 font-medium mb-2">Password *</label>
          <input type="password" name="password" id="password" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
          <p id="passwordHint" class="text-xs text-gray-400 mt-2 font-medium">Minimum 8 characters, including uppercase, lowercase, and numbers</p>
        </div>
        <div>
          <label class="block text-gray-600 font-medium mb-2">Confirm Password *</label>
          <input type="password" name="confirmPassword" id="confirmPassword" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white shadow-sm">
        </div>
        <div class="flex items-start gap-3">
          <input type="checkbox" id="acceptTerms" required class="w-4 h-4 text-pink-500 rounded border-gray-300 mt-1">
          <label for="acceptTerms" class="text-sm text-gray-500 leading-snug">
            I agree to the <span class="text-pink-500">Terms of Service</span> and <span class="text-pink-500">Privacy Policy</span>, and consent to the collection and processing of my personal health data in accordance with PDPA.
          </label>
        </div>
      </div>

      <div id="step3Form" class="hidden text-center">
        <div class="w-14 h-14 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-6 h-6 text-pink-500" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </div>
        <p class="text-gray-500 text-sm mb-6 leading-relaxed">
          We've sent a 6-digit verification code to<br>
          <span id="displayPhone" class="text-gray-700 font-semibold">12345678</span><br>
          <span id="displayEmail" class="text-gray-700 font-semibold">user@example.com</span>
        </p>
        <div class="text-left mb-6">
          <label class="block text-gray-600 font-medium mb-2">Verification Code</label>
          <input type="text" id="otpCode" maxlength="6" placeholder="000000" class="w-full px-4 py-4 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 text-center text-xl tracking-widest text-gray-700 font-semibold">
        </div>
        <p class="text-sm text-gray-500 mb-4">
          Didn't receive the code? <button type="button" class="text-pink-500 font-semibold hover:underline">Resend OTP</button>
        </p>
      </div>

      <div class="flex gap-4 pt-4">
        <button type="button" id="prevBtn" class="flex-1 py-3 border border-gray-200 text-gray-500 rounded-xl hover:bg-gray-50 transition hidden font-medium">
          Back
        </button>
        <button type="button" id="nextBtn" class="flex-1 py-3 bg-pink-500 text-white rounded-xl hover:bg-pink-600 transition font-medium shadow-md shadow-pink-100">
          Continue
        </button>
      </div>

      <div class="text-center mt-6">
        <p class="text-sm text-gray-500 font-medium">
          Already have an account? <a href="{{ url_for('login') }}" class="text-pink-500">Login</a>
        </p>
      </div>
    </form>
  </div>

  <div class="mt-8 flex items-center gap-2 text-gray-400 text-xs font-medium">
    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
    </svg>
    Your data is encrypted and PDPA compliant
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let currentStep = 1;
  const form = document.getElementById('signupForm');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // Logic to handle navigation and validation
  function validateStep(step) {
    if (step === 1) {
      const name = form.querySelector('[name="fullName"]').value;
      const nric = form.querySelector('[name="nric"]').value;
      const phone = form.querySelector('[name="phone"]').value;
      if (!name || !nric || !phone) {
        alert("Please fill in all personal information.");
        return false;
      }
      return true;
    }
    
    if (step === 2) {
      const email = form.querySelector('[name="email"]').value;
      const pass = document.getElementById('password').value;
      const confirmPass = document.getElementById('confirmPassword').value;
      const terms = document.getElementById('acceptTerms').checked;

      // Security Policy Regex: 8+ chars, upper, lower, number
      const securePattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;

      if (!email || !pass) {
        alert("Email and password are required.");
        return false;
      }
      if (!securePattern.test(pass)) {
        alert("Password does not meet security requirements.");
        return false;
      }
      if (pass !== confirmPass) {
        alert("Passwords do not match.");
        return false;
      }
      if (!terms) {
        alert("You must agree to the Terms and Privacy Policy.");
        return false;
      }
      
      // Update Step 3 Display Info
      document.getElementById('displayPhone').textContent = form.querySelector('[name="phone"]').value;
      document.getElementById('displayEmail').textContent = email;
      return true;
    }
    return true;
  }

  function updateStepDisplay() {
    document.getElementById('step1Form').classList.add('hidden');
    document.getElementById('step2Form').classList.add('hidden');
    document.getElementById('step3Form').classList.add('hidden');
    document.getElementById(`step${currentStep}Form`).classList.remove('hidden');

    prevBtn.classList.toggle('hidden', currentStep === 1);
    nextBtn.textContent = currentStep === 3 ? 'Create Account' : 'Continue';

    // UI Progress Bar Logic
    const indicators = document.querySelectorAll('.step-indicator');
    const lines = [document.getElementById('line1'), document.getElementById('line2')];

    indicators.forEach((indicator, idx) => {
      const stepNum = idx + 1;
      const text = indicator.querySelector('span');
      const check = indicator.querySelector('svg');

      if (stepNum < currentStep) {
        indicator.className = "step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-pink-500 text-white font-medium";
        if (text) text.classList.add('hidden');
        if (check) check.classList.remove('hidden');
      } else if (stepNum === currentStep) {
        indicator.className = "step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-pink-500 text-white font-medium";
        if (text) text.classList.remove('hidden');
        if (check) check.classList.add('hidden');
      } else {
        indicator.className = "step-indicator w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 text-gray-400 font-medium";
        if (text) text.classList.remove('hidden');
      }
    });

    lines.forEach((line, idx) => {
      if (line) {
        line.className = `w-16 h-[2px] mx-2 ${idx + 1 < currentStep ? 'bg-pink-500' : 'bg-gray-200'}`;
      }
    });
  }

  nextBtn.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (currentStep === 1) {
      if (validateStep(1)) {
        currentStep++;
        updateStepDisplay();
      }
    } 
    else if (currentStep === 2) {
      if (validateStep(2)) {
        // --- NEW: Trigger the email when moving from Step 2 to Step 3 ---
        nextBtn.textContent = "Sending...";
        nextBtn.disabled = true;

        const formData = new FormData(form);
        fetch('/send_registration_otp', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          nextBtn.disabled = false;
          if (data.success) {
            currentStep++;
            updateStepDisplay();
          } else {
            alert("Error sending email: " + data.message);
            nextBtn.textContent = "Continue";
          }
        })
        .catch(error => {
          nextBtn.disabled = false;
          nextBtn.textContent = "Continue";
          console.error('Error:', error);
        });
      }
    } 
    else if (currentStep === 3) {
      // --- Final Step: Verify OTP and Create Account ---
      const otp = document.getElementById('otpCode').value;
      if (!otp) {
        alert("Please enter the verification code.");
        return;
      }

      const formData = new FormData(form);
      formData.append('otp', otp); // Add the OTP to the form data

      fetch('/final_register', { // Matches your app_1.py route name
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Account created successfully!");
          window.location.href = "{{ url_for('login') }}";
        } else {
          alert("Registration Error: " + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("An error occurred during registration.");
      });
    }
  });

  prevBtn.addEventListener('click', () => {
    if (currentStep > 1) {
      currentStep--;
      updateStepDisplay();
    }
  });

  updateStepDisplay();
</script>
{% endblock %}