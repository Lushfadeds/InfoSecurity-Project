{% extends "base.html" %}

{% block title %}Login - PinkHealth{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-pink-50 to-white min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <a href="{{ url_for('index') }}" class="flex items-center justify-center gap-2 mb-8">
      <div class="w-12 h-12 bg-gradient-to-br from-pink-400 to-pink-500 rounded-lg flex items-center justify-center">
        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </div>
      <span class="text-pink-600 text-2xl font-bold">PinkHealth</span>
    </a>

    <!-- Login Card -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
      <h1 class="text-2xl font-bold text-gray-900 text-center mb-6" id="formTitle">
        Welcome Back
      </h1>

      <form method="POST" id="loginForm" class="space-y-4">
        <!-- Role Selection -->
        <div class="mb-6" id="roleSelection">
          <label class="block text-gray-700 font-medium mb-3">Select Portal</label>
          <div class="grid grid-cols-2 gap-3">
            <!-- Patient -->
            <button type="button" class="role-btn p-4 rounded-lg border-2 border-gray-200 hover:border-pink-300 transition" data-role="patient">
              <svg class="w-6 h-6 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
              </svg>
              <span class="text-sm text-gray-600">Patient</span>
            </button>
            <!-- Doctor -->
            <button type="button" class="role-btn p-4 rounded-lg border-2 border-gray-200 hover:border-blue-300 transition" data-role="doctor">
              <svg class="w-6 h-6 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span class="text-sm text-gray-600">Doctor</span>
            </button>
            <!-- Staff -->
            <button type="button" class="role-btn p-4 rounded-lg border-2 border-gray-200 hover:border-purple-300 transition" data-role="staff">
              <svg class="w-6 h-6 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              <span class="text-sm text-gray-600">Staff</span>
            </button>
            <!-- Admin -->
            <button type="button" class="role-btn p-4 rounded-lg border-2 border-gray-200 hover:border-red-300 transition" data-role="admin">
              <svg class="w-6 h-6 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
              <span class="text-sm text-gray-600">Admin</span>
            </button>
          </div>
        </div>

        <!-- Step 1: Credentials -->
        <div id="step1" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Email</label>
            <input type="email" name="email" id="email" placeholder="your@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" required>
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Password</label>
            <input type="password" name="password" id="password" placeholder="••••••••" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" required>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="remember" class="w-4 h-4 text-pink-600 rounded">
            <label for="remember" class="ml-2 text-sm text-gray-600">Remember me</label>
          </div>
        </div>

        <!-- Step 2: MFA -->
        <div id="step2" class="space-y-4 hidden">
          <p class="text-gray-600 text-sm">A verification code has been sent to your registered email.</p>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Verification Code</label>
            <input type="text" id="totpCode" placeholder="000000" maxlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 text-center text-2xl letter-spacing" required>
          </div>
        </div>

        <!-- Error Message -->
        <div id="errorMsg" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

        <!-- Submit Button -->
        <button type="submit" class="w-full py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition font-medium">
          <span id="submitText">Continue</span>
        </button>

        <!-- Forgot Password Link -->
        <div class="text-center">
          <a href="{{ url_for('reset_password') }}" class="text-pink-600 hover:text-pink-700 text-sm">
            Forgot your password?
          </a>
        </div>

        <!-- Sign Up Link -->
        <div class="text-center text-sm text-gray-600">
          Don't have an account?
          <a href="{{ url_for('signup') }}" class="text-pink-600 hover:text-pink-700 font-medium">
            Register as Patient
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script>
    let selectedRole = '';
    let currentStep = 1;

    // Role selection
    document.querySelectorAll('.role-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        selectedRole = this.getAttribute('data-role');
        document.querySelectorAll('.role-btn').forEach(b => {
          b.classList.remove('border-pink-500', 'bg-pink-50', 'border-blue-500', 'bg-blue-50', 'border-purple-500', 'bg-purple-50', 'border-red-500', 'bg-red-50');
          b.classList.add('border-gray-200');
        });
        const colors = {
          patient: ['border-pink-500', 'bg-pink-50'],
          doctor: ['border-blue-500', 'bg-blue-50'],
          staff: ['border-purple-500', 'bg-purple-50'],
          admin: ['border-red-500', 'bg-red-50']
        };
        this.classList.remove('border-gray-200');
        this.classList.add(...colors[selectedRole]);
      });
    });

    // Form submission
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!selectedRole) {
        document.getElementById('errorMsg').textContent = 'Please select a portal';
        document.getElementById('errorMsg').classList.remove('hidden');
        return;
      }

      if (currentStep === 1) {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          document.getElementById('errorMsg').textContent = 'Please enter email and password';
          document.getElementById('errorMsg').classList.remove('hidden');
          return;
        }

        // Show MFA step
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        document.getElementById('submitText').textContent = 'Login';
        document.getElementById('formTitle').textContent = 'Two-Factor Authentication';
        document.getElementById('errorMsg').classList.add('hidden');
        currentStep = 2;
      } else {
        // Submit the form
        this.submit();
      }
    });

    // Auto-select role from URL parameter
    const params = new URLSearchParams(window.location.search);
    const urlRole = params.get('role');
    if (urlRole) {
      const roleBtn = document.querySelector(`.role-btn[data-role="${urlRole}"]`);
      if (roleBtn) roleBtn.click();
    }
  </script>
{% endblock %}