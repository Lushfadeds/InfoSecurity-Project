{% extends "base.html" %}

{% block title %}Data Erasure Management - PinkHealth{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="flex">
    {% set active_page = 'data-erasure' %}
    {% include 'includes/staff-sidebar.html' %}

    <main class="flex-1 p-8">
      <div class="max-w-5xl mx-auto">
        <div class="mb-4">
          <h1 class="text-3xl font-bold text-gray-900 mb-4">Data Erasure Management</h1>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-blue-700 font-semibold">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3l7 4v5c0 5-3.5 9-7 9s-7-4-7-9V7l7-4z"></path>
              </svg>
              <span>Deletion Scope - Staff:</span>
            </div>
            <p class="text-gray-600 mt-2">You can request deletion of documents at Internal and Public classification levels only.</p>
          </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">Recent Erasure Requests Status</h2>
          </div>
          <div class="space-y-3">
            {% if recent_requests and recent_requests|length > 0 %}
              {% for req in recent_requests %}
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <p class="text-gray-900 font-medium">Request #{{ req.id }}</p>
                    <p class="text-gray-600 text-sm">Reason: {{ req.reason }}</p>
                    {% if req.status == 'rejected' and req.rejection_reason %}
                      <p class="text-red-700 text-sm mt-2 font-medium">Rejection Reason: {{ req.rejection_reason }}</p>
                    {% endif %}
                  </div>
                  {% if req.status == 'approved' %}
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded font-medium">approved</span>
                  {% elif req.status == 'rejected' %}
                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded font-medium">rejected</span>
                  {% else %}
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded font-medium">pending</span>
                  {% endif %}
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500">
                  <span>{{ req.documents_count }} document(s)</span>
                  <span>Requested: {{ req.created_at }}{% if req.rejected_at %} â€¢ Rejected: {{ req.rejected_at }}{% endif %}</span>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-gray-600">No erasure requests submitted yet.</p>
            {% endif %}
          </div>
        </div>

        <form method="POST" class="space-y-6" id="erasure-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-900">Select Documents to Erase</h2>
            </div>
            <div class="space-y-3 max-h-72 overflow-y-auto pr-2">
              {% if documents and documents|length > 0 %}
                {% for doc in documents %}
                <label class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-purple-300 transition">
                  <input type="checkbox" name="documents" value="{{ doc.value }}" class="mt-1 h-4 w-4 text-purple-600 border-gray-300 rounded">
                  <div class="flex-1">
                    <p class="text-gray-900 font-medium">
                      {% if doc.type == 'administrative' %}
                        Administrative - {{ doc.title }}
                      {% else %}
                        Walk-in Appointment - {{ doc.patient_name }}
                      {% endif %}
                    </p>
                    {% if doc.type == 'appointment' %}
                      <p class="text-gray-600 text-xs">NRIC: {{ doc.masked_nric }}</p>
                      <p class="text-gray-600 text-xs">Doctor: {{ doc.doctor_name }}</p>
                    {% elif doc.type == 'administrative' %}
                      <p class="text-gray-600 text-xs">Type: {{ doc.record_type|title }}</p>
                      {% if doc.attachments %}
                        {% for attachment in doc.attachments %}
                          {% if '.pdf' in attachment.filename.lower() %}
                            <p class="text-gray-600 text-xs">File: {{ attachment.filename }}</p>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endif %}
                    <p class="text-gray-600 text-xs">Creation Date: {{ doc.created_at }}</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded
                    {% if doc.classification == 'internal' %}
                      bg-blue-100 text-blue-800
                    {% else %}
                      bg-green-100 text-green-800
                    {% endif %}
                  ">{{ doc.classification|title }}</span>
                </label>
                {% endfor %}
              {% else %}
                <p class="text-gray-600">No documents available for erasure.</p>
              {% endif %}
            </div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <label class="block text-sm font-semibold text-gray-900 mb-2">Reasons for Erasure (Compulsory)</label>
            <textarea name="reason" required rows="3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="Provide a reason for erasure..."></textarea>
          </div>

          <div class="bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-red-700">Warning: Deletion Request Requires Approval</p>
                <p class="text-sm text-red-600">Your erasure request will be sent to Admin for review and approval. The Admin will determine the appropriate deletion method based on security policies.</p>
              </div>
            </div>
          </div>

          <button type="submit" id="submit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition">
            Submit Erasure Request (0 documents)
          </button>
        </form>
      </div>
    </main>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    const form = document.getElementById('erasure-form');
    const submitBtn = document.getElementById('submit-btn');
    const checkboxes = form ? form.querySelectorAll('input[name="documents"]') : [];

    function updateCount() {
      const count = Array.from(checkboxes).filter(cb => cb.checked).length;
      submitBtn.textContent = `Submit Erasure Request (${count} document${count === 1 ? '' : 's'})`;
    }

    if (form) {
      checkboxes.forEach(cb => cb.addEventListener('change', updateCount));
      updateCount();

      form.addEventListener('submit', function (e) {
        const count = Array.from(checkboxes).filter(cb => cb.checked).length;
        const reason = form.querySelector('[name="reason"]').value.trim();

        if (count === 0) {
          e.preventDefault();
          alert('Please select at least one document to erase.');
          return;
        }

        if (!reason) {
          e.preventDefault();
          alert('Please provide a reason for erasure.');
          return;
        }

        const confirmed = confirm(`Warning: Your erasure request requires Admin approval. Do you want to proceed?`);
        if (!confirmed) {
          e.preventDefault();
        }
      });
    }
  })();
</script>
{% endblock %}
