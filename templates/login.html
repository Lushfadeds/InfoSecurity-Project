{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="h3 mb-3">Login</h1>

          {% if submitted %}
            <div class="row justify-content-center">
              <div class="col-md-8">
                {% if error %}
                  <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if signup_error %}
                  <div class="alert alert-danger">{{ signup_error }}</div>
                {% endif %}
                {% if signup_success %}
                  <div class="alert alert-success">{{ signup_success }}</div>
                {% endif %}

                <div class="text-center mb-3">
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#authModal">Sign in / Sign up</button>
                </div>

                <!-- Fallback inline login form for direct page access -->
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h1 class="h3 mb-3">Sign in</h1>
                    <form id="inline-login-form" action="{{ url_for('login') }}" method="post">
                      <input type="hidden" name="form_type" value="login" />
                      <div class="mb-3">
                        <label for="username" class="form-label">Email</label>
                        <input id="username" name="username" type="email" class="form-control" required>
                      </div>
                      <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" name="password" type="password" class="form-control" required>
                      </div>
                      <div class="text-end">
                        <button type="submit" class="btn btn-primary">Sign in</button>
                      </div>
                    </form>
                  </div>
                </div>

                <div id="login-react" class="mt-3">Loading login helper...</div>
                <script type="module" src="{{ url_for('static', filename='react/assets/main.js') }}"></script>
              </div>
            </div>

            <script type="application/json" id="modalServerJson">
              {{ {
                'error': error|default(None),
                'signup_error': signup_error|default(None),
                'signup_success': signup_success|default(None)
              } | tojson }}
            </script>
            <script>
              // Read server messages from the JSON script tag to avoid JS/templating parsing issues
              document.addEventListener('DOMContentLoaded', function(){
                var el = document.getElementById('modalServerJson');
                var modalServer = null;
                if (el) {
                  try { modalServer = JSON.parse(el.textContent); } catch(e) { modalServer = null; }
                }
                window.modalServer = modalServer;
                if (modalServer && (modalServer.error || modalServer.signup_error || modalServer.signup_success)) {
                  var m = new bootstrap.Modal(document.getElementById('authModal'));
                  m.show();
                }
              });
            </script>
