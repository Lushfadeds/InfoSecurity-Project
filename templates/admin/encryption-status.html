{% extends "base.html" %}

{% block title %}Encryption Status - PinkHealth{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="flex">
    {% set active_page = 'encryption' %}
    {% include 'includes/admin-navbar.html' %}

    <main class="flex-1 p-8">
      <div class="max-w-7xl mx-auto">
        <div class="mb-6">
          <h1 class="text-3xl font-bold text-pink-900 mb-2">Encryption Status</h1>
          <p class="text-gray-600">End-to-end encryption, key management, and field-level masking overview</p>
        </div>

        <!-- Overall Status -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 mb-6 text-white">
          <div class="flex items-center gap-4 mb-4">
            <div class="p-4 bg-white/20 rounded-lg">
              <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold mb-1">Fully Encrypted</h2>
              <p class="text-green-100">All data encrypted with industry-standard algorithms</p>
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-4 pt-4 border-t border-white/20">
            <div>
              <p class="text-green-100 text-sm">Encryption Algorithm</p>
              <p class="text-lg font-semibold">AES-256-GCM</p>
            </div>
            <div>
              <p class="text-green-100 text-sm">Key Management</p>
              <p class="text-lg font-semibold">Envelope Encryption</p>
            </div>
            <div>
              <p class="text-green-100 text-sm">PHI Fields Protected</p>
              <p class="text-lg font-semibold">12 Fields</p>
            </div>
          </div>
        </div>

        <!-- Role-Based Data Masking Demo -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-xl font-bold text-purple-900 mb-1 flex items-center gap-2">
                <i data-lucide="eye" class="w-6 h-6"></i>
                Field-Level Masking Demo
              </h2>
              <p class="text-sm text-purple-700">See how data appears to different roles</p>
            </div>
            <select id="roleSelector" onchange="updateMaskingDemo()" class="px-4 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
              <option value="admin">üë§ View as: Admin (Full Access)</option>
              <option value="doctor">üë®‚Äç‚öïÔ∏è View as: Doctor</option>
              <option value="patient">üßë View as: Patient (Self)</option>
              <option value="staff">üìã View as: Staff</option>
              <option value="pharmacy">üíä View as: Pharmacy</option>
            </select>
          </div>
          
          <div class="bg-white rounded-lg border border-purple-200 p-5">
            <h3 class="text-gray-900 font-semibold mb-4 pb-2 border-b border-gray-200">Sample Patient Record</h3>
            <div id="maskingDemo" class="grid md:grid-cols-2 gap-x-8 gap-y-3 text-sm">
              <!-- Populated by JavaScript -->
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 flex items-center gap-2 text-xs text-purple-700">
              <i data-lucide="eye-off" class="w-4 h-4"></i>
              <span>Fields in orange are masked/tokenized based on role permissions</span>
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="border-b border-gray-200 p-4">
            <h2 class="text-xl font-bold text-pink-900">Encryption Coverage by Data Category</h2>
            <p class="text-sm text-gray-600 mt-1">Click any category to view encryption details</p>
          </div>
          <div class="p-4 grid md:grid-cols-2 gap-4">
            <!-- Patient Data -->
            <div onclick="showCategoryDetails('patient')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="database" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Patient Data (At Rest)</p>
                    <p class="text-sm text-gray-500">AES-256-GCM</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Full database encryption with per-record DEKs</p>
            </div>

            <!-- Data in Transit -->
            <div onclick="showCategoryDetails('transit')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="cloud" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Data in Transit</p>
                    <p class="text-sm text-gray-500">TLS 1.3</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">All network traffic encrypted with latest TLS</p>
            </div>

            <!-- File Storage -->
            <div onclick="showCategoryDetails('files')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="hard-drive" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">File Storage</p>
                    <p class="text-sm text-gray-500">AES-256-GCM + Envelope</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Per-file encryption with unique DEK, wrapped with master KEK</p>
            </div>

            <!-- Backup Data -->
            <div onclick="showCategoryDetails('backup')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="file-text" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Backup Data</p>
                    <p class="text-sm text-gray-500">AES-256-GCM</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Encrypted backups with separate key hierarchy</p>
            </div>

            <!-- API Communications -->
            <div onclick="showCategoryDetails('api')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="shield" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">API Communications</p>
                    <p class="text-sm text-gray-500">TLS 1.3 + JWT</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">End-to-end encryption for all API requests</p>
            </div>

            <!-- User Credentials -->
            <div onclick="showCategoryDetails('credentials')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="key" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">User Credentials</p>
                    <p class="text-sm text-gray-500">Argon2id</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Password hashing with salt and memory-hard algorithm</p>
            </div>
          </div>
        </div>

        <!-- Category Details Modal -->
        <div id="categoryModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
          <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 text-white flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold mb-1">Encryption Coverage Details</h2>
                <p id="modalCategoryName" class="text-green-100 text-sm"></p>
              </div>
              <button onclick="closeCategoryModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
            </div>
            <div id="modalContent" class="p-6 space-y-5 overflow-y-auto max-h-[calc(90vh-120px)]">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-6">
          <!-- Key Management -->
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="border-b border-gray-200 p-4 flex items-center justify-between">
              <h2 class="text-xl font-bold text-pink-900">Key Management & Lifecycle</h2>
              <button onclick="simulateKeyRotation()" id="rotateBtn" class="px-3 py-1.5 text-sm rounded-lg bg-pink-600 text-white hover:bg-pink-700 transition-colors">
                Simulate Rotation
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Key Type</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Rotation</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">Master Key (KEK)</p>
                          <p class="text-xs text-gray-500">Local Key Store</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900">On Demand</p>
                      <p class="text-xs text-gray-500">Environment Variable</p>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">Data Encryption Keys (DEK)</p>
                          <p class="text-xs text-gray-500">Per-Record Generation</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900">Per-Field</p>
                      <p class="text-xs text-gray-500">Unique per encryption</p>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">File Encryption Key</p>
                          <p class="text-xs text-gray-500">Per-File DEK</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900">Per-Upload</p>
                      <p class="text-xs text-gray-500">Envelope encryption</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Security Implementation -->
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="border-b border-gray-200 p-4">
              <h2 class="text-xl font-bold text-pink-900">Security Implementation</h2>
            </div>
            <div class="p-4 space-y-3">
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Envelope Encryption</p>
                    <p class="text-sm text-gray-500">Two-layer key hierarchy</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">DEKs encrypted with KEK, stored alongside ciphertext</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Authenticated Encryption</p>
                    <p class="text-sm text-gray-500">AES-256-GCM Mode</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">Provides confidentiality and integrity verification</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Nonce/IV Generation</p>
                    <p class="text-sm text-gray-500">Cryptographically Random</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">12-byte random nonce per encryption operation</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Encrypted Fields List -->
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="border-b border-gray-200 p-4">
            <h2 class="text-xl font-bold text-pink-900">Protected PHI Fields</h2>
            <p class="text-sm text-gray-600 mt-1">Fields encrypted at rest in the database</p>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Full Name</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">NRIC</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Date of Birth</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Phone Number</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Email Address</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Address</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Postal Code</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Nationality</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Gender</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Medical History</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Allergies</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Prescriptions</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Compliance Note -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <i data-lucide="shield" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div>
              <h3 class="font-semibold text-blue-900 mb-1">Compliance & Standards</h3>
              <p class="text-sm text-blue-800">
                PinkHealth encryption practices comply with HIPAA, PDPA (Singapore), and industry best practices 
                for healthcare data security. All encryption uses AES-256-GCM with envelope encryption pattern. 
                Every decrypt operation creates an immutable audit event for compliance tracking.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
  <div class="flex items-center gap-2">
    <i data-lucide="check-circle" class="w-5 h-5"></i>
    <span id="toastMessage">Success</span>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  // Sample patient data for role-based viewing
  const samplePatientData = {
    admin: {
      nric: 'S1234567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9123 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    doctor: {
      nric: 'S****567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9*** 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    patient: {
      nric: 'S1234567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9123 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    staff: {
      nric: 'S****567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '[MASKED]',
      phone: '+65 9*** 4567',
      email: 'sarah.lee@example.com',
      diagnosis: '[MASKED]',
      notes: '[MASKED]'
    },
    pharmacy: {
      nric: 'S****567A',
      name: 'Sarah L***',
      dob: '[MASKED]',
      address: '[MASKED]',
      phone: '[MASKED]',
      email: '[MASKED]',
      diagnosis: '[MASKED]',
      notes: '[MASKED] - Prescription details only'
    }
  };

  // Category details data
  const categoryDetails = {
    patient: {
      name: 'Patient Data (At Rest)',
      method: 'AES-256-GCM',
      description: 'Full database encryption with per-record Data Encryption Keys (DEKs)',
      keyScope: 'Per-record DEK wrapped with Master KEK',
      fields: ['NRIC', 'Full Name', 'Address', 'Phone Number', 'Date of Birth', 'Email', 'Medical History', 'Diagnosis Notes', 'Allergies', 'Prescriptions']
    },
    transit: {
      name: 'Data in Transit',
      method: 'TLS 1.3',
      description: 'All network traffic encrypted with latest TLS protocol',
      keyScope: 'Session-based ephemeral keys with Perfect Forward Secrecy',
      fields: ['All API Requests', 'All API Responses', 'WebSocket Connections', 'File Uploads/Downloads']
    },
    files: {
      name: 'File Storage',
      method: 'AES-256-GCM',
      description: 'Document storage with per-file encryption keys using envelope encryption',
      keyScope: 'Per-file DEK with envelope encryption',
      fields: ['Medical Certificates', 'Prescriptions', 'Lab Reports', 'X-ray Images', 'Uploaded Documents']
    },
    backup: {
      name: 'Backup Data',
      method: 'AES-256-GCM',
      description: 'Encrypted backups with separate key hierarchy for disaster recovery',
      keyScope: 'Backup-specific KEK for isolation',
      fields: ['Database Snapshots', 'File Storage Archives', 'Audit Log Backups', 'Configuration Backups']
    },
    api: {
      name: 'API Communications',
      method: 'TLS 1.3 + JWT',
      description: 'End-to-end encryption for all API requests with token-based authentication',
      keyScope: 'JWT signing keys + TLS certificates',
      fields: ['Request Headers', 'Request Body', 'Response Payload', 'Authentication Tokens']
    },
    credentials: {
      name: 'User Credentials',
      method: 'Argon2id',
      description: 'Password hashing with salt and memory-hard algorithm resistant to GPU attacks',
      keyScope: 'Per-user salt + application pepper',
      fields: ['Passwords', 'Security Questions', 'Recovery Codes', '2FA Secrets']
    }
  };

  function updateMaskingDemo() {
    const role = document.getElementById('roleSelector').value;
    const data = samplePatientData[role];
    const container = document.getElementById('maskingDemo');
    
    const isMasked = (value) => value.includes('*') || value.includes('[MASKED]');
    const getClass = (value) => isMasked(value) ? 'text-orange-600' : 'text-gray-900';
    
    container.innerHTML = `
      <div>
        <span class="text-gray-600">NRIC:</span>
        <span class="ml-2 font-medium ${getClass(data.nric)}">${data.nric}</span>
      </div>
      <div>
        <span class="text-gray-600">Full Name:</span>
        <span class="ml-2 font-medium ${getClass(data.name)}">${data.name}</span>
      </div>
      <div>
        <span class="text-gray-600">Date of Birth:</span>
        <span class="ml-2 font-medium ${getClass(data.dob)}">${data.dob}</span>
      </div>
      <div>
        <span class="text-gray-600">Phone:</span>
        <span class="ml-2 font-medium ${getClass(data.phone)}">${data.phone}</span>
      </div>
      <div class="md:col-span-2">
        <span class="text-gray-600">Address:</span>
        <span class="ml-2 font-medium ${getClass(data.address)}">${data.address}</span>
      </div>
      <div>
        <span class="text-gray-600">Email:</span>
        <span class="ml-2 font-medium ${getClass(data.email)}">${data.email}</span>
      </div>
      <div>
        <span class="text-gray-600">Diagnosis:</span>
        <span class="ml-2 font-medium ${getClass(data.diagnosis)}">${data.diagnosis}</span>
      </div>
      <div class="md:col-span-2 pt-2 border-t border-gray-200">
        <span class="text-gray-600 block mb-1">Clinical Notes:</span>
        <span class="font-medium ${getClass(data.notes)}">${data.notes}</span>
      </div>
    `;
  }

  function showCategoryDetails(category) {
    const details = categoryDetails[category];
    const modal = document.getElementById('categoryModal');
    const content = document.getElementById('modalContent');
    document.getElementById('modalCategoryName').textContent = details.name;
    
    content.innerHTML = `
      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="lock" class="w-5 h-5 text-green-600"></i>
          Encryption Method
        </h3>
        <div class="bg-green-50 rounded-lg p-3 text-sm">
          <p class="text-green-900 font-medium">${details.method}</p>
          <p class="text-green-700 mt-1">${details.description}</p>
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="key" class="w-5 h-5 text-blue-600"></i>
          Key Scope
        </h3>
        <div class="bg-blue-50 rounded-lg p-3 text-sm">
          <p class="text-blue-900">${details.keyScope}</p>
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="database" class="w-5 h-5 text-purple-600"></i>
          Protected Fields
        </h3>
        <div class="bg-purple-50 rounded-lg p-3">
          <div class="grid grid-cols-2 gap-2">
            ${details.fields.map(field => `
              <div class="flex items-center gap-2 text-sm text-purple-900">
                <i data-lucide="check-circle" class="w-3 h-3 text-purple-600"></i>
                ${field}
              </div>
            `).join('')}
          </div>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-2">
          <i data-lucide="shield" class="w-5 h-5 text-blue-600 mt-0.5"></i>
          <div class="text-sm">
            <p class="text-blue-900 font-medium mb-1">Security Note</p>
            <p class="text-blue-800">
              All encryption operations follow industry best practices. Keys use envelope encryption 
              and are never exposed to the application layer in plaintext form.
            </p>
          </div>
        </div>
      </div>
    `;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lucide.createIcons();
  }

  function closeCategoryModal() {
    const modal = document.getElementById('categoryModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function simulateKeyRotation() {
    const btn = document.getElementById('rotateBtn');
    btn.disabled = true;
    btn.textContent = 'Rotating...';
    btn.classList.add('bg-gray-400');
    btn.classList.remove('bg-pink-600', 'hover:bg-pink-700');
    
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = 'Simulate Rotation';
      btn.classList.remove('bg-gray-400');
      btn.classList.add('bg-pink-600', 'hover:bg-pink-700');
      showToast('Key rotation simulation completed. New DEKs generated, old DEKs revoked, audit events created.');
    }, 2000);
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    toast.classList.remove('translate-y-20', 'opacity-0');
    
    setTimeout(() => {
      toast.classList.add('translate-y-20', 'opacity-0');
    }, 4000);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    updateMaskingDemo();
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeCategoryModal();
    }
  });

  // Close modal on background click
  document.getElementById('categoryModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closeCategoryModal();
    }
  });
</script>
{% endblock %}
