{% extends "base.html" %}

{% block title %}Encryption Status - PinkHealth{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="flex">
    {% set active_page = 'encryption' %}
    {% include 'includes/admin-navbar.html' %}

    <main class="flex-1 p-8">
      <div class="max-w-7xl mx-auto">
        <div class="mb-6">
          <h1 class="text-3xl font-bold text-pink-900 mb-2">Encryption Status</h1>
          <p class="text-gray-600">End-to-end encryption, key management, and field-level masking overview</p>
        </div>

        <!-- Overall Status -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 mb-6 text-white">
          <div class="flex items-center gap-4 mb-4">
            <div class="p-4 bg-white/20 rounded-lg">
              <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold mb-1">Fully Encrypted</h2>
              <p class="text-green-100">All data encrypted with industry-standard algorithms</p>
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-4 pt-4 border-t border-white/20">
            <div>
              <p class="text-green-100 text-sm">Encryption Algorithm</p>
              <p class="text-lg font-semibold">AES-256-GCM</p>
            </div>
            <div>
              <p class="text-green-100 text-sm">Key Management</p>
              <p class="text-lg font-semibold">Envelope Encryption</p>
            </div>
            <div>
              <p class="text-green-100 text-sm">PHI Fields Protected</p>
              <p class="text-lg font-semibold">7 Fields</p>
            </div>
          </div>
        </div>

        <!-- Role-Based Data Masking Demo -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-xl font-bold text-purple-900 mb-1 flex items-center gap-2">
                <i data-lucide="eye" class="w-6 h-6"></i>
                Field-Level Masking Demo
              </h2>
              <p class="text-sm text-purple-700">See how data appears to different roles</p>
            </div>
            <select id="roleSelector" onchange="updateMaskingDemo()" class="px-4 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
              <option value="admin">üë§ View as: Admin (Full Access)</option>
              <option value="doctor">üë®‚Äç‚öïÔ∏è View as: Doctor</option>
              <option value="patient">üßë View as: Patient (Self)</option>
              <option value="staff">üìã View as: Staff</option>
              <option value="pharmacy">üíä View as: Pharmacy</option>
            </select>
          </div>
          
          <div class="bg-white rounded-lg border border-purple-200 p-5">
            <h3 class="text-gray-900 font-semibold mb-4 pb-2 border-b border-gray-200">Sample Patient Record</h3>
            <div id="maskingDemo" class="grid md:grid-cols-2 gap-x-8 gap-y-3 text-sm">
              <!-- Populated by JavaScript -->
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 flex items-center gap-2 text-xs text-purple-700">
              <i data-lucide="eye-off" class="w-4 h-4"></i>
              <span>Fields in orange are masked/tokenized based on role permissions</span>
            </div>
          </div>
        </div>

        <!-- Data Categories -->
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="border-b border-gray-200 p-4">
            <h2 class="text-xl font-bold text-pink-900">Encryption Coverage by Data Category</h2>
            <p class="text-sm text-gray-600 mt-1">Click any category to view encryption details</p>
          </div>
          <div class="p-4 grid md:grid-cols-2 gap-4">
            <!-- Patient Data -->
            <div onclick="showCategoryDetails('patient')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="database" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Patient Data (At Rest)</p>
                    <p class="text-sm text-gray-500">AES-256-GCM</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Full database encryption with per-record DEKs</p>
            </div>

            <!-- Data in Transit -->
            <div onclick="showCategoryDetails('transit')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="cloud" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Data in Transit</p>
                    <p class="text-sm text-gray-500">HTTPS / TLS</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">All Supabase API traffic encrypted over HTTPS</p>
            </div>

            <!-- File Storage -->
            <div onclick="showCategoryDetails('files')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="hard-drive" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">File Storage</p>
                    <p class="text-sm text-gray-500">AES-256-GCM + Envelope</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Per-file encryption with unique DEK, wrapped with master KEK</p>
            </div>

            <!-- Audit Logs -->
            <div onclick="showCategoryDetails('audit')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="file-text" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Audit Logs</p>
                    <p class="text-sm text-gray-500">SHA-256 Hash Chain</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Immutable hash chain with tamper-evident append-only storage</p>
            </div>

            <!-- Patient Documents -->
            <div onclick="showCategoryDetails('documents')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="file-lock" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">Patient Documents</p>
                    <p class="text-sm text-gray-500">AES-256-GCM + Envelope</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Patient-uploaded documents encrypted with per-file DEK before storage</p>
            </div>

            <!-- User Credentials -->
            <div onclick="showCategoryDetails('credentials')" class="border border-gray-200 rounded-lg p-4 hover:border-pink-400 hover:shadow-md transition-all cursor-pointer">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="key" class="w-5 h-5 text-green-600"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">User Credentials</p>
                    <p class="text-sm text-gray-500">bcrypt (Supabase Auth)</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-600">Password hashing delegated to Supabase Auth with bcrypt</p>
            </div>
          </div>
        </div>

        <!-- Category Details Modal -->
        <div id="categoryModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
          <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 text-white flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold mb-1">Encryption Coverage Details</h2>
                <p id="modalCategoryName" class="text-green-100 text-sm"></p>
              </div>
              <button onclick="closeCategoryModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
            </div>
            <div id="modalContent" class="p-6 space-y-5 overflow-y-auto max-h-[calc(90vh-120px)]">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-6">
          <!-- Key Management -->
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="border-b border-gray-200 p-4">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-bold text-pink-900">Key Management & Lifecycle</h2>
                <button onclick="rotateKmsKey()" id="rotateBtn" class="px-3 py-1.5 text-sm rounded-lg bg-pink-600 text-white hover:bg-pink-700 transition-colors flex items-center gap-1.5">
                  <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  Rotate KEK
                </button>
              </div>
              <div id="kmsStatus" class="bg-gray-50 rounded-lg p-3 text-sm text-gray-600">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 border-2 border-gray-300 border-t-pink-600 rounded-full animate-spin"></div>
                  Loading KMS status...
                </div>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Key Type</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Rotation</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">Master Key (KEK)</p>
                          <p class="text-xs text-gray-500">AWS KMS</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span id="kekStatusBadge" class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900" id="kekRotationInfo">AWS Managed</p>
                      <p class="text-xs text-gray-500" id="kekRotationDetail">Loading...</p>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">Data Encryption Keys (DEK)</p>
                          <p class="text-xs text-gray-500">Per-User Generation</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900">Per-User</p>
                      <p class="text-xs text-gray-500">Generated on registration</p>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400"></i>
                        <div>
                          <p class="text-sm font-medium text-gray-900">File Encryption Key</p>
                          <p class="text-xs text-gray-500">Per-File DEK</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm text-gray-900">Per-Upload</p>
                      <p class="text-xs text-gray-500">Envelope encryption</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Security Implementation -->
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="border-b border-gray-200 p-4">
              <h2 class="text-xl font-bold text-pink-900">Security Implementation</h2>
            </div>
            <div class="p-4 space-y-3">
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Envelope Encryption</p>
                    <p class="text-sm text-gray-500">Two-layer key hierarchy</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">DEKs encrypted with KEK, stored alongside ciphertext</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Authenticated Encryption</p>
                    <p class="text-sm text-gray-500">AES-256-GCM Mode</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">Provides confidentiality and integrity verification</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <p class="font-medium text-gray-900">Nonce/IV Generation</p>
                    <p class="text-sm text-gray-500">Cryptographically Random</p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Implemented</span>
                </div>
                <p class="text-xs text-gray-600">12-byte random nonce per encryption operation</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Encrypted Fields List -->
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="border-b border-gray-200 p-4">
            <h2 class="text-xl font-bold text-pink-900">Protected PHI Fields</h2>
            <p class="text-sm text-gray-600 mt-1">Fields encrypted at rest in the database</p>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">NRIC</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Date of Birth</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Phone Number</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Address</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Postal Code</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Clinical Notes</span>
              </div>
              <div class="flex items-center gap-2 p-3 bg-green-50 rounded-lg">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <span class="text-sm text-green-900">Prescriptions (Medications)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Compliance Note -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <i data-lucide="shield" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div>
              <h3 class="font-semibold text-blue-900 mb-1">Compliance & Standards</h3>
              <p class="text-sm text-blue-800">
                PinkHealth encryption practices comply with HIPAA, PDPA (Singapore), and industry best practices 
                for healthcare data security. All encryption uses AES-256-GCM with envelope encryption pattern. 
                Every decrypt operation creates an immutable audit event for compliance tracking.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
  <div class="flex items-center gap-2">
    <i data-lucide="check-circle" class="w-5 h-5"></i>
    <span id="toastMessage">Success</span>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  // Sample patient data for role-based viewing
  const samplePatientData = {
    admin: {
      nric: 'S1234567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9123 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    doctor: {
      nric: 'S****567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9*** 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    patient: {
      nric: 'S1234567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '123 Orchard Road, #05-67, Singapore 238858',
      phone: '+65 9123 4567',
      email: 'sarah.lee@example.com',
      diagnosis: 'Acute Upper Respiratory Tract Infection',
      notes: 'Patient presented with fever, cough, and sore throat for 3 days. Prescribed Amoxicillin 500mg TDS for 5 days.'
    },
    staff: {
      nric: 'S****567A',
      name: 'Sarah Lee Mei Ling',
      dob: '15 March 1990',
      address: '[MASKED]',
      phone: '+65 9*** 4567',
      email: 'sarah.lee@example.com',
      diagnosis: '[MASKED]',
      notes: '[MASKED]'
    },
    pharmacy: {
      nric: 'S****567A',
      name: 'Sarah L***',
      dob: '[MASKED]',
      address: '[MASKED]',
      phone: '[MASKED]',
      email: '[MASKED]',
      diagnosis: '[MASKED]',
      notes: '[MASKED] - Prescription details only'
    }
  };

  // Category details data
  const categoryDetails = {
    patient: {
      name: 'Patient Data (At Rest)',
      method: 'AES-256-GCM',
      description: 'Field-level encryption with per-user Data Encryption Keys (DEKs) wrapped by AWS KMS KEK',
      keyScope: 'Per-user DEK generated on registration, wrapped with KEK via AWS KMS',
      fields: ['NRIC', 'Date of Birth', 'Phone Number', 'Address', 'Postal Code', 'Clinical Notes', 'Prescriptions (Medications)']
    },
    transit: {
      name: 'Data in Transit',
      method: 'HTTPS / TLS',
      description: 'All Supabase API traffic is encrypted over HTTPS. TLS is managed by Supabase infrastructure.',
      keyScope: 'Managed by Supabase ‚Äî session-based ephemeral keys',
      fields: ['Supabase API Requests', 'Supabase API Responses', 'File Uploads/Downloads']
    },
    files: {
      name: 'File Storage',
      method: 'AES-256-GCM',
      description: 'Patient document uploads encrypted with per-file DEK using envelope encryption',
      keyScope: 'Per-file DEK generated on upload, wrapped with KEK',
      fields: ['Patient Uploaded Documents', 'Medical Certificates', 'Lab Reports']
    },
    credentials: {
      name: 'User Credentials',
      method: 'bcrypt (Supabase Auth)',
      description: 'Password hashing delegated to Supabase Auth, which uses bcrypt with per-user salt',
      keyScope: 'Managed by Supabase Auth ‚Äî per-user salt',
      fields: ['Passwords']
    },
    audit: {
      name: 'Audit Logs',
      method: 'SHA-256 Hash Chain',
      description: 'Each audit entry is hashed with SHA-256 and linked to the previous entry\'s hash, creating a tamper-evident chain. Entries are stored in append-only local file, Supabase (with immutable trigger), and optional S3 offsite backup.',
      keyScope: 'No encryption keys ‚Äî integrity via cryptographic hash chain',
      fields: ['Event Hash (SHA-256)', 'Previous Hash Link', 'Append-Only Local File', 'Immutable DB Trigger (prevents UPDATE/DELETE)', 'Optional S3 Offsite Replication']
    },
    documents: {
      name: 'Patient Documents',
      method: 'AES-256-GCM + Envelope',
      description: 'Patient-uploaded documents (PDFs, images, etc.) are encrypted with a unique per-file DEK before being stored in Supabase Storage. The DEK is wrapped with the master KEK via AWS KMS.',
      keyScope: 'Per-file DEK generated on upload, wrapped with KEK',
      fields: ['Medical Certificates', 'Lab Reports', 'Patient-Uploaded PDFs', 'Supporting Documents']
    }
  };

  function updateMaskingDemo() {
    const role = document.getElementById('roleSelector').value;
    const data = samplePatientData[role];
    const container = document.getElementById('maskingDemo');
    
    const isMasked = (value) => value.includes('*') || value.includes('[MASKED]');
    const getClass = (value) => isMasked(value) ? 'text-orange-600' : 'text-gray-900';
    
    container.innerHTML = `
      <div>
        <span class="text-gray-600">NRIC:</span>
        <span class="ml-2 font-medium ${getClass(data.nric)}">${data.nric}</span>
      </div>
      <div>
        <span class="text-gray-600">Full Name:</span>
        <span class="ml-2 font-medium ${getClass(data.name)}">${data.name}</span>
      </div>
      <div>
        <span class="text-gray-600">Date of Birth:</span>
        <span class="ml-2 font-medium ${getClass(data.dob)}">${data.dob}</span>
      </div>
      <div>
        <span class="text-gray-600">Phone:</span>
        <span class="ml-2 font-medium ${getClass(data.phone)}">${data.phone}</span>
      </div>
      <div class="md:col-span-2">
        <span class="text-gray-600">Address:</span>
        <span class="ml-2 font-medium ${getClass(data.address)}">${data.address}</span>
      </div>
      <div>
        <span class="text-gray-600">Email:</span>
        <span class="ml-2 font-medium ${getClass(data.email)}">${data.email}</span>
      </div>
      <div>
        <span class="text-gray-600">Diagnosis:</span>
        <span class="ml-2 font-medium ${getClass(data.diagnosis)}">${data.diagnosis}</span>
      </div>
      <div class="md:col-span-2 pt-2 border-t border-gray-200">
        <span class="text-gray-600 block mb-1">Clinical Notes:</span>
        <span class="font-medium ${getClass(data.notes)}">${data.notes}</span>
      </div>
    `;
  }

  function showCategoryDetails(category) {
    const details = categoryDetails[category];
    const modal = document.getElementById('categoryModal');
    const content = document.getElementById('modalContent');
    document.getElementById('modalCategoryName').textContent = details.name;
    
    content.innerHTML = `
      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="lock" class="w-5 h-5 text-green-600"></i>
          Encryption Method
        </h3>
        <div class="bg-green-50 rounded-lg p-3 text-sm">
          <p class="text-green-900 font-medium">${details.method}</p>
          <p class="text-green-700 mt-1">${details.description}</p>
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="key" class="w-5 h-5 text-blue-600"></i>
          Key Scope
        </h3>
        <div class="bg-blue-50 rounded-lg p-3 text-sm">
          <p class="text-blue-900">${details.keyScope}</p>
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <i data-lucide="database" class="w-5 h-5 text-purple-600"></i>
          Protected Fields
        </h3>
        <div class="bg-purple-50 rounded-lg p-3">
          <div class="grid grid-cols-2 gap-2">
            ${details.fields.map(field => `
              <div class="flex items-center gap-2 text-sm text-purple-900">
                <i data-lucide="check-circle" class="w-3 h-3 text-purple-600"></i>
                ${field}
              </div>
            `).join('')}
          </div>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-2">
          <i data-lucide="shield" class="w-5 h-5 text-blue-600 mt-0.5"></i>
          <div class="text-sm">
            <p class="text-blue-900 font-medium mb-1">Security Note</p>
            <p class="text-blue-800">
              All encryption operations follow industry best practices. Keys use envelope encryption 
              and are never exposed to the application layer in plaintext form.
            </p>
          </div>
        </div>
      </div>
    `;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lucide.createIcons();
  }

  function closeCategoryModal() {
    const modal = document.getElementById('categoryModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    toast.classList.remove('translate-y-20', 'opacity-0');
    
    setTimeout(() => {
      toast.classList.add('translate-y-20', 'opacity-0');
    }, 4000);
  }

  // KMS Rotation functions
  async function loadKmsStatus() {
    try {
      const response = await fetch('/api/admin/kms-rotation-status');
      const data = await response.json();
      const statusEl = document.getElementById('kmsStatus');
      const rotInfoEl = document.getElementById('kekRotationInfo');
      const rotDetailEl = document.getElementById('kekRotationDetail');
      const badgeEl = document.getElementById('kekStatusBadge');
      
      if (!data.available) {
        statusEl.innerHTML = `<span class="text-yellow-700">‚ö†Ô∏è KMS not configured: ${data.message || 'AWS_KMS_KEY_ID not set'}</span>`;
        rotInfoEl.textContent = 'Not available';
        rotDetailEl.textContent = 'KMS not configured';
        document.getElementById('rotateBtn').disabled = true;
        document.getElementById('rotateBtn').classList.add('opacity-50', 'cursor-not-allowed');
        return;
      }
      
      badgeEl.textContent = data.key_state || 'Active';
      
      let statusHtml = `<div class="grid grid-cols-2 gap-x-6 gap-y-1">`;
      statusHtml += `<div><span class="text-gray-500">Key State:</span> <span class="font-medium text-green-700">${data.key_state}</span></div>`;
      statusHtml += `<div><span class="text-gray-500">Key Spec:</span> <span class="font-medium">${data.key_spec}</span></div>`;
      statusHtml += `<div><span class="text-gray-500">Auto Rotation:</span> <span class="font-medium ${data.auto_rotation_enabled ? 'text-green-700' : 'text-gray-700'}">${data.auto_rotation_enabled ? 'Enabled' : 'Disabled'}</span></div>`;
      if (data.next_rotation_date) {
        const nextDate = new Date(data.next_rotation_date).toLocaleDateString();
        statusHtml += `<div><span class="text-gray-500">Next Rotation:</span> <span class="font-medium">${nextDate}</span></div>`;
      }
      if (data.creation_date) {
        const createdDate = new Date(data.creation_date).toLocaleDateString();
        statusHtml += `<div><span class="text-gray-500">Key Created:</span> <span class="font-medium">${createdDate}</span></div>`;
      }
      statusHtml += `</div>`;
      statusEl.innerHTML = statusHtml;
      
      rotInfoEl.textContent = 'On-Demand';
      rotDetailEl.textContent = data.auto_rotation_enabled ? 'Auto rotation + manual via button' : 'Manual via Rotate KEK button';
    } catch (error) {
      console.error('Failed to load KMS status:', error);
      document.getElementById('kmsStatus').innerHTML = '<span class="text-red-600">Failed to load KMS status</span>';
    }
  }

  async function rotateKmsKey() {
    if (!confirm('Rotate the KMS master key (KEK)?\n\nThis generates new key material in AWS KMS. All existing encrypted data will continue to work ‚Äî AWS KMS preserves old key versions automatically.\n\nProceed?')) {
      return;
    }
    const btn = document.getElementById('rotateBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Rotating...';
    
    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      const response = await fetch('/api/admin/kms-rotate', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message);
        // Reload status to reflect changes
        await loadKmsStatus();
      } else {
        showToast('Rotation failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      showToast('Rotation failed: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Rotate KEK';
      lucide.createIcons();
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    updateMaskingDemo();
    loadKmsStatus();
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeCategoryModal();
    }
  });

  // Close modal on background click
  document.getElementById('categoryModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closeCategoryModal();
    }
  });
</script>
{% endblock %}
