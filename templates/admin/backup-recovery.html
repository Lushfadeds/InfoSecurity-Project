{% extends 'base.html' %}

{% block title %}Backup & Recovery - PinkHealth Admin{% endblock %}

{% block content %}
<style>
    .h1 { font-size: 2rem; font-weight: 700; }
    .h2 { font-size: 1.25rem; font-weight: 600; }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
</style>

<div class="flex">
{% set active_page = 'backup' %}
{% include 'includes/admin-navbar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-4 lg:p-8">
            <div class="max-w-7xl mx-auto">
                <div class="mb-6">
                    <h1 class="text-pink-900 mb-2 h1">Backup & Recovery</h1>
                    <p class="text-gray-600">Manage data backups and disaster recovery</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl text-gray-900">{{ backups|selectattr('status', 'equalto', 'Completed')|list|length }}</p>
                                <p class="text-sm text-gray-600">Successful Backups</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <i data-lucide="database" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl text-gray-900">{{ backups[0].size if backups else '0' }}</p>
                                <p class="text-sm text-gray-600">Latest Backup Size</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <i data-lucide="clock" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl text-gray-900">365</p>
                                <p class="text-sm text-gray-600">Retention Days</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-orange-50 rounded-lg">
                                <i data-lucide="refresh-cw" class="w-6 h-6 text-orange-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl text-gray-900">{{ time_since_last_backup }}</p>
                                <p class="text-sm text-gray-600">Last Backup</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-6 mb-6">
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h2 class="text-pink-900 mb-4 h2">Quick Actions</h2>
                        <div class="space-y-3">
                            <form method="POST" action="{{ url_for('admin_trigger_backup') }}">
                                <button
                                id="backupBtn"
                                type="submit"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors"
                                >
                                <i data-lucide="database" class="w-5 h-5" id="backupIcon"></i>
                                <span id="backupText">Initiate Manual Backup</span>
                            </button>
                            </form>
                    <!-- Restore from Backup -->
                    <div>
                        <input id="restore-file-input" type="file" accept=".sql" class="hidden"/>
                        <button id="restore-btn"
                            class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            <span id="restore-btn-text">Restore from Backup</span>
                        </button>
                    </div>
                            <a
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                href="{{ backups[0].file_url if backups and backups[0].file_url else '#' }}"
                                {% if not backups or not backups[0].file_url %}aria-disabled="true"{% endif %}
                                download
                            >
                                <i data-lucide="download" class="w-5 h-5"></i>
                                Download Backup
                            </a>
                        </div>
                    </div>

                    <!-- Backup Configuration -->
                    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 p-6">
                        <h2 class="text-pink-900 mb-4 h2">Backup Configuration</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-gray-200">
                                <span class="text-gray-600">Backup Frequency</span>
                                <span class="text-gray-900">Daily at 2:00 AM SGT</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-200">
                                <span class="text-gray-600">Retention Period</span>
                                <span class="text-gray-900">365 days</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-200">
                                <span class="text-gray-600">Encryption</span>
                                <span class="text-gray-900">AES-256</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-200">
                                <span class="text-gray-600">Storage Location</span>
                                <span class="text-gray-900">AWS RDS - ap-southeast-1 </span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-600">Replication</span>
                                <span class="text-gray-900">Asia Pacific (Singapore)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup History -->
                <div class="bg-white rounded-lg border border-gray-200">
                    <div class="border-b border-gray-200 p-4">
                        <h2 class="text-pink-900 h2">Backup History</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Backup ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Timestamp</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Type</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for backup in backups %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ backup.id }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">{{ backup.timestamp }}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 text-xs rounded-full {% if backup.type == 'manual' %}bg-purple-100 text-purple-700{% else %}bg-blue-100 text-blue-700{% endif %}">{{ backup.type }}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="flex items-center gap-1 text-sm {% if backup.status == 'Completed' %}text-green-600{% elif backup.status == 'Failed' %}text-red-600{% else %}text-yellow-600{% endif %}">
                                            <i data-lucide="{% if backup.status == 'Completed' %}check-circle{% elif backup.status == 'Failed' %}x-circle{% else %}clock{% endif %}" class="w-4 h-4"></i>
                                            {{ backup.status }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-2">
                                            <button class="p-1 hover:bg-gray-200 rounded" title="Restore">
                                                <i data-lucide="upload" class="w-4 h-4 text-gray-600"></i>
                                            </button>
                                            <a class="p-1 hover:bg-gray-200 rounded" title="Download" href="{{ backup.file_url }}" download>
                                                <i data-lucide="download" class="w-4 h-4 text-gray-600"></i>
                                            </a>
                                            <!-- Verify integrity button ‚Äî opens modal pre-filled with this backup's ID -->
                                            {% if backup.checksum %}
                                            <button class="p-1 hover:bg-gray-200 rounded verify-btn"
                                                title="Verify integrity"
                                                data-backup-id="{{ backup.id }}"
                                                data-checksum="{{ backup.checksum }}">
                                                <i data-lucide="shield-check" class="w-4 h-4 text-blue-600"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ Integrity Verification Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="mt-6 bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-blue-50 rounded-lg">
                            <i data-lucide="shield-check" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h2 class="text-pink-900 h2">Verify Backup Integrity</h2>
                            <p class="text-xs text-gray-500 mt-0.5">Upload a downloaded backup file to verify it hasn't been tampered with</p>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Left: upload + backup ID -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Backup ID</label>
                                <input id="verify-backup-id" type="text" placeholder="e.g. 3a7f2b..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-pink-500 font-mono"/>
                                <p class="text-xs text-gray-400 mt-1">Click the üõ° icon on any row to auto-fill this</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Backup File (.sql)</label>
                                <div id="drop-zone"
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-pink-400 transition-colors">
                                    <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                    <p class="text-sm text-gray-500">Drop your .sql file here or <span class="text-pink-500 underline">browse</span></p>
                                    <p id="file-name-display" class="text-xs text-gray-400 mt-1">No file selected</p>
                                    <input id="verify-file-input" type="file" accept=".sql" class="hidden"/>
                                </div>
                            </div>
                            <button id="verify-btn"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                                <span id="verify-btn-text">Verify Integrity</span>
                            </button>
                        </div>

                        <!-- Right: result panel -->
                        <div id="verify-result" class="hidden flex flex-col justify-center">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden transform transition-all duration-300">
    <p id="toast-message"></p>
</div>
</div>
<!-- ‚îÄ‚îÄ Restore Confirmation Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="restore-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <div class="bg-red-50 border-b border-red-200 px-6 py-4 flex items-center gap-3">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <div>
                <h3 class="font-semibold text-gray-900 text-base">Confirm Database Restore</h3>
                <p class="text-xs text-red-600 mt-0.5">This will overwrite all current data</p>
            </div>
        </div>
        <div class="px-6 py-4 space-y-3">
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="text-sm text-red-700 font-medium">‚ö†Ô∏è This action cannot be undone.</p>
                <p class="text-xs text-red-600 mt-1">The current database will be overwritten with the contents of the selected backup file. All data created after this backup was taken will be lost.</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                <p class="text-xs text-gray-500 font-medium mb-1">FILE TO RESTORE</p>
                <p id="restore-filename" class="text-sm text-gray-800 font-mono truncate"></p>
            </div>
            <!-- Progress bar ‚Äî shown during upload + restore -->
            <div id="restore-progress-wrap" class="hidden space-y-1">
                <div class="flex justify-between text-xs text-gray-500">
                    <span id="restore-status-text">Uploading...</span>
                    <span id="restore-pct">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="restore-progress-bar" class="bg-pink-500 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
                </div>
            </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex gap-2">
            <button id="restore-confirm-btn"
                class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition">
                ‚úÖ Yes, Restore Database
            </button>
            <button id="restore-cancel-btn"
                class="flex-1 px-4 py-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition">
                Cancel
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    lucide.createIcons();

    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => { toast.classList.add('hidden'); }, 3000);
    }

    // ‚îÄ‚îÄ Pre-fill verify panel when shield icon is clicked ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelectorAll('.verify-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('verify-backup-id').value = btn.dataset.backupId;
            // Scroll to verify panel
            document.getElementById('verify-result').closest('.mt-6').scrollIntoView({ behavior: 'smooth' });
            checkVerifyReady();
        });
    });

    // ‚îÄ‚îÄ File drop zone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dropZone   = document.getElementById('drop-zone');
    const fileInput  = document.getElementById('verify-file-input');
    const fileLabel  = document.getElementById('file-name-display');
    let   selectedFile = null;

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-pink-400', 'bg-pink-50');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-pink-400', 'bg-pink-50');
    });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-pink-400', 'bg-pink-50');
        const file = e.dataTransfer.files[0];
        if (file) setFile(file);
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files[0]) setFile(fileInput.files[0]);
    });

    function setFile(file) {
        selectedFile = file;
        fileLabel.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        dropZone.classList.add('border-green-400', 'bg-green-50');
        checkVerifyReady();
    }

    document.getElementById('verify-backup-id').addEventListener('input', checkVerifyReady);

    function checkVerifyReady() {
        const hasId   = document.getElementById('verify-backup-id').value.trim() !== '';
        const hasFile = selectedFile !== null;
        document.getElementById('verify-btn').disabled = !(hasId && hasFile);
    }

    // ‚îÄ‚îÄ Merkle Tree ‚Äî mirrors the Lambda's get_merkle_root() exactly ‚îÄ‚îÄ‚îÄ
    // CHUNK_SIZE must match the Lambda (1 MB)
    const CHUNK_SIZE = 1024 * 1024;

    async function sha256hex(buffer) {
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        return Array.from(new Uint8Array(hashBuffer))
            .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function getMerkleRoot(file) {
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        let hashes = [];

        // 1. Hash each 1MB chunk
        for (let i = 0; i < totalChunks; i++) {
            const start  = i * CHUNK_SIZE;
            const end    = Math.min(start + CHUNK_SIZE, file.size);
            const chunk  = file.slice(start, end);
            const buffer = await chunk.arrayBuffer();
            hashes.push(await sha256hex(buffer));
        }

        // Empty file edge case
        if (hashes.length === 0) {
            const empty = await sha256hex(new ArrayBuffer(0));
            return empty;
        }

        // 2. Build Merkle tree ‚Äî combine pairs until one root remains
        while (hashes.length > 1) {
            const newLevel = [];
            for (let i = 0; i < hashes.length; i += 2) {
                const left  = hashes[i];
                const right = i + 1 < hashes.length ? hashes[i + 1] : left; // duplicate last if odd
                const combined = left + right;
                // Lambda does: hashlib.sha256(combined.encode()).hexdigest()
                // combined is a hex string ‚Äî encode as UTF-8 bytes
                const enc = new TextEncoder().encode(combined);
                newLevel.push(await sha256hex(enc));
            }
            hashes = newLevel;
        }

        return hashes[0];
    }

    // ‚îÄ‚îÄ Verify button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('verify-btn').addEventListener('click', async () => {
        const backupId  = document.getElementById('verify-backup-id').value.trim();
        const resultDiv = document.getElementById('verify-result');
        const btnText   = document.getElementById('verify-btn-text');
        const btn       = document.getElementById('verify-btn');

        // Show loading state
        btn.disabled = true;
        btnText.textContent = 'Computing Merkle root‚Ä¶';
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full gap-3 text-gray-400">
                <svg class="w-8 h-8 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
                <p class="text-sm">Computing Merkle root for <strong>${selectedFile.name}</strong>‚Ä¶</p>
                <p class="text-xs">This may take a moment for large files</p>
            </div>`;

        try {
            // 1. Compute Merkle root of the uploaded file (client-side)
            const computedRoot = await getMerkleRoot(selectedFile);

            // 2. Fetch the stored checksum from the server for this backup ID
            const res  = await fetch(`/admin/backup_checksum/${backupId}`);
            const data = await res.json();

            // 404 = backup ID not found ‚Äî show as a lookup failure, not a server error
            if (res.status === 404) {
                resultDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-5 space-y-2">
                        <div class="flex items-center gap-2 text-yellow-700">
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-semibold text-sm">Backup Record Not Found</span>
                        </div>
                        <p class="text-xs text-yellow-600">${data.error}</p>
                        <p class="text-xs text-yellow-500">Make sure you selected the correct backup row before uploading the file.</p>
                    </div>`;
                return; // exit early ‚Äî this is not a tamper, just a wrong ID
            }

            if (!res.ok) {
                throw new Error(data.error || 'Could not fetch stored checksum');
            }

            const storedRoot = data.checksum;
            const match      = computedRoot.toLowerCase() === storedRoot.toLowerCase();

            // 3. Show result
            if (match) {
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-5 space-y-3">
                        <div class="flex items-center gap-2 text-green-700">
                            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span class="font-semibold text-base">Integrity Verified ‚úì</span>
                        </div>
                        <p class="text-sm text-green-600">The file matches the stored Merkle root exactly. This backup has not been tampered with.</p>
                        <div class="space-y-1 text-xs font-mono bg-white rounded p-3 border border-green-100 break-all">
                            <p class="text-gray-500">Computed root:</p>
                            <p class="text-green-700">${computedRoot}</p>
                            <p class="text-gray-500 mt-2">Stored root:</p>
                            <p class="text-green-700">${storedRoot}</p>
                        </div>
                    </div>`;
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-5 space-y-3">
                        <div class="flex items-center gap-2 text-red-700">
                            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span class="font-semibold text-base">Integrity Check Failed ‚úó</span>
                        </div>
                        <p class="text-sm text-red-600">The Merkle root does not match. This file may have been corrupted or tampered with. Do not use this backup.</p>
                        <div class="space-y-1 text-xs font-mono bg-white rounded p-3 border border-red-100 break-all">
                            <p class="text-gray-500">Computed root:</p>
                            <p class="text-red-600">${computedRoot}</p>
                            <p class="text-gray-500 mt-2">Stored root (expected):</p>
                            <p class="text-green-700">${storedRoot}</p>
                        </div>
                    </div>`;
            }
        } catch (err) {
            resultDiv.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-5">
                    <p class="text-sm font-semibold text-yellow-700 mb-1">Verification Error</p>
                    <p class="text-xs text-yellow-600">${err.message}</p>
                </div>`;
        } finally {
            btn.disabled = false;
            btnText.textContent = 'Verify Integrity';
        }
    });

    // ‚îÄ‚îÄ Restore from Backup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const restoreInput   = document.getElementById('restore-file-input');
    const restoreBtn     = document.getElementById('restore-btn');
    const restoreModal   = document.getElementById('restore-modal');
    const restoreConfirm = document.getElementById('restore-confirm-btn');
    const restoreCancel  = document.getElementById('restore-cancel-btn');
    let   restoreFile    = null;

    // Step 1: click button ‚Üí open file picker
    restoreBtn.addEventListener('click', () => restoreInput.click());

    // Step 2: file selected ‚Üí show confirmation modal
    restoreInput.addEventListener('change', () => {
        if (!restoreInput.files[0]) return;
        restoreFile = restoreInput.files[0];
        document.getElementById('restore-filename').textContent =
            `${restoreFile.name} (${(restoreFile.size / 1024 / 1024).toFixed(2)} MB)`;
        document.getElementById('restore-progress-wrap').classList.add('hidden');
        restoreConfirm.disabled = false;
        restoreConfirm.textContent = '‚úÖ Yes, Restore Database';
        restoreModal.classList.remove('hidden');
    });

    // Cancel
    restoreCancel.addEventListener('click', () => {
        restoreModal.classList.add('hidden');
        restoreInput.value = '';
        restoreFile = null;
    });

    // Step 3: confirmed ‚Üí upload .sql directly to Flask, which runs psql
    restoreConfirm.addEventListener('click', async () => {
        if (!restoreFile) return;

        const progressWrap = document.getElementById('restore-progress-wrap');
        const progressBar  = document.getElementById('restore-progress-bar');
        const progressPct  = document.getElementById('restore-pct');
        const statusText   = document.getElementById('restore-status-text');

        restoreConfirm.disabled = true;
        restoreConfirm.textContent = 'Working‚Ä¶';
        progressWrap.classList.remove('hidden');

        try {
            statusText.textContent = 'Uploading and restoring‚Ä¶';
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content
                           || "{{ csrf_token() }}";

            // Send the file as multipart/form-data with XHR so we get upload progress
            const formData = new FormData();
            formData.append('file', restoreFile);

            await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/admin/trigger_restore');
                xhr.setRequestHeader('X-CSRFToken', csrfToken);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 80);
                        progressBar.style.width = pct + '%';
                        progressPct.textContent = pct + '%';
                    }
                };

                xhr.onload = () => {
                    const data = JSON.parse(xhr.responseText);
                    if (xhr.status === 200) {
                        resolve(data);
                    } else {
                        reject(new Error(data.error || `Server error ${xhr.status}`));
                    }
                };
                xhr.onerror = () => reject(new Error('Network error ‚Äî could not reach server'));
                xhr.send(formData);
            });

            // Done
            progressBar.style.width = '100%';
            progressPct.textContent = '100%';
            progressBar.classList.replace('bg-pink-500', 'bg-green-500');
            statusText.textContent = '‚úÖ Restore completed successfully';
            restoreConfirm.textContent = 'Done';
            showToast('Database restored successfully.');

        } catch (err) {
            statusText.textContent = `‚ùå ${err.message}`;
            progressBar.classList.replace('bg-pink-500', 'bg-red-500');
            restoreConfirm.disabled = false;
            restoreConfirm.textContent = '‚úÖ Yes, Restore Database';
        }
    });
</script>
{% endblock %}