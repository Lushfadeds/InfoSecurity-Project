{% extends 'base.html' %}

{% block title %}Audit Logs - PinkHealth Admin{% endblock %}

{% block content %}
<style>
    .h1 {
        font-size: 2rem;
        font-weight: 700;
    }
    .h2 {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .h3 {
        font-size: 1rem;
        font-weight: 600;
    }
    /* Custom scrollbar */
    .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
    }
    .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<div class="flex">
        {% set active_page = 'audit-logs' %}
        <!-- Sidebar -->
        {% include 'includes/admin-navbar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-4 lg:p-8">
            <div class="max-w-7xl mx-auto">
                <div class="mb-6 flex flex-col sm:flex-row items-start justify-between gap-4">
                    <div>
                        <h1 class="text-pink-900 mb-2 h1">Audit Logs</h1>
                        <p class="text-gray-600">Immutable record of all system activities with hash chain verification</p>
                    </div>
                    <button 
                        onclick="handleExportWithIntegrity()"
                        class="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors"
                    >
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Export with Integrity Proof
                    </button>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <p class="text-2xl text-gray-900" id="stat-total">12</p>
                        <p class="text-sm text-gray-600">Total Events Today</p>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <p class="text-2xl text-green-600" id="stat-success">9</p>
                        <p class="text-sm text-gray-600">Successful</p>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <p class="text-2xl text-red-600" id="stat-failed">2</p>
                        <p class="text-sm text-gray-600">Failed</p>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <p class="text-2xl text-teal-600" id="stat-dlp-scans">6</p>
                        <p class="text-sm text-gray-600">DLP Scans</p>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <p class="text-2xl text-red-700" id="stat-dlp-blocked">1</p>
                        <p class="text-sm text-gray-600">DLP Blocked</p>
                    </div>
                </div>

                <!-- Security-Centric Quick Filters -->
                <div class="bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="shield" class="w-5 h-5 text-pink-600"></i>
                        <h3 class="text-pink-900 h3">Security Monitoring Filters</h3>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setSecurityFilter('all')" data-filter="all" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-pink-600 text-white">
                            All Events
                        </button>
                        <button onclick="setSecurityFilter('phi_access')" data-filter="phi_access" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-blue-400">
                            üîí PHI Access Events
                        </button>
                        <button onclick="setSecurityFilter('failed_auth')" data-filter="failed_auth" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-red-400">
                            ‚ö†Ô∏è Failed Auth + Brute Force
                        </button>
                        <button onclick="setSecurityFilter('export_events')" data-filter="export_events" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-orange-400">
                            üì§ Export/Download (Data Exfil Risk)
                        </button>
                        <button onclick="setSecurityFilter('high_risk')" data-filter="high_risk" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-purple-400">
                            üö® High-Risk Actions
                        </button>
                        <button onclick="setSecurityFilter('dlp_scans')" data-filter="dlp_scans" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-teal-400">
                            üìÑ DLP Document Scans
                        </button>
                        <button onclick="setSecurityFilter('dlp_blocked')" data-filter="dlp_blocked" class="security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-red-400">
                            üõë DLP Blocked Uploads
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Search logs..."
                                oninput="filterLogs()"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                            />
                        </div>
                        <select id="filterAction" onchange="filterLogs()" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                            <option value="all">All Actions</option>
                            <option value="VIEW">View</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="UPLOAD">Upload (DLP Scan)</option>
                            <option value="DOWNLOAD">Download</option>
                            <option value="EXPORT">Export</option>
                            <option value="LOGIN">Login</option>
                        </select>
                        <select id="filterStatus" onchange="filterLogs()" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                            <option value="all">All Status</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                            <option value="warning">Warning</option>
                        </select>
                        <select id="dateRange" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="border-b border-gray-200 p-4 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="lock" class="w-5 h-5 text-pink-600"></i>
                            <h2 class="text-pink-900 h2">Immutable Audit Trail</h2>
                        </div>
                        <span class="text-sm text-gray-500">Blockchain-verified records with hash chain</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Timestamp</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">User</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Action</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resource</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody" class="divide-y divide-gray-200">
                                <!-- Logs will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

<!-- Forensic Details Drawer -->
    <div id="forensicDrawer" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-end">
        <div class="bg-white h-full w-full max-w-2xl shadow-2xl overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 p-6 text-white flex items-center justify-between">
                <div>
                    <h2 class="text-xl mb-1">Forensic Details</h2>
                    <p class="text-purple-100 text-sm">Deep dive into log event <span id="forensic-log-id"></span></p>
                </div>
                <button onclick="closeForensicDrawer()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <!-- Basic Info -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="file-text" class="w-5 h-5 text-purple-600"></i>
                        Event Information
                    </h3>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2 text-sm" id="forensic-basic-info">
                    </div>
                </div>

                <!-- Device & Location -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="monitor" class="w-5 h-5 text-blue-600"></i>
                        Device & Location
                    </h3>
                    <div class="bg-blue-50 rounded-lg p-4 space-y-2 text-sm" id="forensic-device-info">
                    </div>
                </div>

                <!-- Policy Decision -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="shield" class="w-5 h-5 text-green-600"></i>
                        Access Control Decision (ABAC)
                    </h3>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-green-900" id="forensic-policy"></p>
                    </div>
                </div>

                <!-- Masking Applied -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="eye" class="w-5 h-5 text-orange-600"></i>
                        Data Masking & Tokenization Applied
                    </h3>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <ul class="space-y-1" id="forensic-masking">
                        </ul>
                    </div>
                </div>

                <!-- Action Payload -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="database" class="w-5 h-5 text-gray-600"></i>
                        Action Payload (Metadata)
                    </h3>
                    <div class="bg-gray-100 rounded-lg p-4">
                        <pre class="text-xs text-gray-800 font-mono overflow-x-auto" id="forensic-payload"></pre>
                    </div>
                </div>

                <!-- Hash Chain -->
                <div>
                    <h3 class="text-gray-900 mb-3 flex items-center gap-2 h3">
                        <i data-lucide="key" class="w-5 h-5 text-pink-600"></i>
                        Hash Chain Verification
                    </h3>
                    <div class="bg-pink-50 rounded-lg p-4 space-y-2 text-sm" id="forensic-hash">
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden transform transition-all duration-300">
    <p id="toast-message"></p>
</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Dynamic audit log data - fetched from API
        let allLogs = [];
        let currentSecurityFilter = 'all';
        let currentHashVerification = null;
        let isLoading = false;

        // Fetch logs from API
        async function fetchLogs() {
            if (isLoading) return;
            isLoading = true;
            
            const dateRange = document.getElementById('dateRange').value;
            const actionFilter = document.getElementById('filterAction').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const searchTerm = document.getElementById('searchInput').value;
            
            try {
                const params = new URLSearchParams({
                    date_range: dateRange,
                    action: actionFilter,
                    status: statusFilter,
                    search: searchTerm,
                    security_filter: currentSecurityFilter,
                    limit: 200
                });
                
                const response = await fetch(`/api/admin/audit-logs?${params}`);
                if (!response.ok) throw new Error('Failed to fetch logs');
                
                const data = await response.json();
                allLogs = data.logs.map(log => transformLogForDisplay(log));
                
                // Update stats from API response
                updateStatsFromAPI(data.stats);
                
                renderLogs(allLogs);
            } catch (error) {
                console.error('Error fetching logs:', error);
                showToast('Failed to load audit logs');
            } finally {
                isLoading = false;
            }
        }

        // Transform API log to display format
        function transformLogForDisplay(log) {
            // Debug: Log the raw user_agent from database
            console.log('Raw log from API:', { id: log.id, user_agent: log.user_agent, ip_address: log.ip_address });
            
            // Build resource description
            let resource = log.resource || log.action;
            let details = '';
            
            // Add classification info
            if (log.classification) {
                details = `Classification: ${log.classification.charAt(0).toUpperCase() + log.classification.slice(1)}`;
            }
            
            // Check for DLP-related info in extra
            const extra = log.extra || {};
            if (extra.dlp_verdict) {
                resource = `${log.action} - Document (DLP SCAN)`;
                if (extra.dlp_verdict === 'BLOCKED') {
                    resource = `${log.action} - Document (DLP BLOCKED)`;
                }
                details = extra.dlp_details || details;
            }
            
            // Build action payload from extra data
            const actionPayload = extra.fileName ? {
                fileName: extra.fileName,
                fileSize: extra.fileSize || 'N/A',
                classification: log.classification,
                phiElements: extra.phi_tags ? extra.phi_tags.split(', ') : [],
                dlpVerdict: extra.dlp_verdict || 'N/A'
            } : extra;

            // Parse user agent for device info
            const deviceInfo = parseUserAgent(log.user_agent || '');
            
            // Determine geo location based on IP (basic inference)
            const geoLocation = inferGeoLocation(log.ip_address);
            
            return {
                id: log.id || `LOG-${Date.now()}`,
                timestamp: formatTimestamp(log.timestamp),
                user: log.user || 'Unknown User',
                role: log.role || 'unknown',
                action: log.action || 'UNKNOWN',
                resource: resource,
                ipAddress: log.ip_address || '127.0.0.1',
                userAgent: log.user_agent || '',
                status: log.status || 'success',
                details: details || `Action: ${log.action}`,
                hash: log.hash || '',
                prevHash: log.prev_hash || '',
                verified: log.verified || false,
                requestId: `REQ-${formatRequestId(log.timestamp)}`,
                sessionId: `SESS-${(log.user || 'Unknown').replace(/\s+/g, '')}-${formatSessionId(log.timestamp)}`,
                deviceFingerprint: deviceInfo.device,
                geoLocation: geoLocation,
                policyDecision: buildPolicyDecision(log),
                maskingApplied: buildMaskingApplied(log),
                actionPayload: actionPayload
            };
        }
        
        // Infer geo location from IP address
        function inferGeoLocation(ip) {
            if (!ip) return 'Unknown Location';
            if (ip === '127.0.0.1' || ip === 'localhost') return 'Localhost (Local Machine)';
            if (ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.')) {
                return 'Private Network (Internal)';
            }
            // For public IPs, we'd need a geo-IP service
            // For now, indicate it's an external IP
            return `External IP: ${ip}`;
        }

        // Helper functions
        function formatTimestamp(ts) {
            if (!ts) return 'N/A';
            try {
                // If timestamp doesn't have timezone info, treat it as UTC
                let dateStr = ts;
                if (!ts.includes('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
                    // No timezone indicator - assume UTC
                    dateStr = ts.replace(' ', 'T') + 'Z';
                }
                const date = new Date(dateStr);
                
                // Format in local timezone (Singapore UTC+8)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch {
                return ts;
            }
        }

        function formatRequestId(ts) {
            if (!ts) return Date.now();
            try {
                const date = new Date(ts);
                return date.toISOString().replace(/[-:T]/g, '').substring(0, 14) + '01';
            } catch {
                return Date.now();
            }
        }

        function formatSessionId(ts) {
            if (!ts) return 'Unknown';
            try {
                const date = new Date(ts);
                return date.toISOString().substring(0, 10).replace(/-/g, '');
            } catch {
                return 'Unknown';
            }
        }

        function parseUserAgent(ua) {
            if (!ua) return { device: 'Unknown Device' };
            
            let browser = 'Unknown';
            let os = 'Unknown';
            
            // Check Edge/Edg BEFORE Chrome (Edge UA contains "Chrome")
            if (ua.includes('Edg/') || ua.includes('Edge/')) {
                browser = 'Edge ' + (ua.match(/Edg\/(\d+)/) || ua.match(/Edge\/(\d+)/) || ['', ''])[1];
            } else if (ua.includes('Chrome')) {
                browser = 'Chrome ' + (ua.match(/Chrome\/(\d+)/) || ['', ''])[1];
            } else if (ua.includes('Firefox')) {
                browser = 'Firefox ' + (ua.match(/Firefox\/(\d+)/) || ['', ''])[1];
            } else if (ua.includes('Safari')) {
                browser = 'Safari ' + (ua.match(/Version\/(\d+)/) || ['', ''])[1];
            }
            
            if (ua.includes('Windows')) os = 'Windows ' + (ua.includes('Windows NT 10') ? '10/11' : '');
            else if (ua.includes('Mac')) os = 'macOS';
            else if (ua.includes('Linux')) os = 'Linux';
            else if (ua.includes('Android')) os = 'Android';
            else if (ua.includes('iOS') || ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';
            
            return { device: `${browser} / ${os}`.trim() };
        }

        function buildPolicyDecision(log) {
            const status = (log.status || '').toLowerCase();
            const action = log.action || '';
            const role = log.role || 'unknown';
            const classification = log.classification || 'internal';
            
            if (status === 'success') {
                return `Allowed: role=${role}, action=${action}, classification=${classification}`;
            } else if (status === 'denied' || status === 'failed') {
                return `Denied: Insufficient permissions or policy violation`;
            } else if (status === 'warning') {
                return `Allowed with warning: role=${role}, requires_review=true`;
            }
            return `Policy decision: ${status}`;
        }

        function buildMaskingApplied(log) {
            const masks = [];
            const classification = (log.classification || '').toLowerCase();
            
            if (classification === 'restricted' || classification === 'confidential') {
                masks.push('NRIC partially masked');
                masks.push('Address removed');
            }
            if (classification === 'critical') {
                masks.push('All PHI fields tokenized');
            }
            if (masks.length === 0) {
                masks.push('None - No PHI detected');
            }
            return masks;
        }

        function updateStatsFromAPI(stats) {
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-success').textContent = stats.success || 0;
            document.getElementById('stat-failed').textContent = stats.failed || 0;
            document.getElementById('stat-dlp-scans').textContent = stats.dlp_scans || 0;
            document.getElementById('stat-dlp-blocked').textContent = stats.dlp_blocked || 0;
        }

        // Initialize page
        async function init() {
            await fetchLogs();
        }

        // Set security filter
        function setSecurityFilter(filter) {
            currentSecurityFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.security-filter-btn').forEach(btn => {
                const btnFilter = btn.getAttribute('data-filter');
                if (btnFilter === filter) {
                    btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-pink-600 text-white';
                    if (filter === 'phi_access') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-blue-600 text-white';
                    if (filter === 'failed_auth') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-red-600 text-white';
                    if (filter === 'export_events') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-orange-600 text-white';
                    if (filter === 'high_risk') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-purple-600 text-white';
                    if (filter === 'dlp_scans') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-teal-600 text-white';
                    if (filter === 'dlp_blocked') btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-red-700 text-white';
                } else {
                    btn.className = 'security-filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-white text-gray-700 border border-gray-300 hover:border-pink-400';
                }
            });
            
            fetchLogs();
        }

        // Filter logs - now triggers API fetch
        function filterLogs() {
            fetchLogs();
        }

        // Debounce for search input
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterLogs, 300);
        });

        // Listen for filter changes
        document.getElementById('filterAction').addEventListener('change', filterLogs);
        document.getElementById('filterStatus').addEventListener('change', filterLogs);
        document.getElementById('dateRange').addEventListener('change', filterLogs);

        // Render logs
        function renderLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                            <p>No audit logs found for the selected criteria</p>
                            <p class="text-sm">Try adjusting filters or date range</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = '';
            
            logs.forEach(log => {
                const isDLPScan = log.action === 'UPLOAD' && (log.resource.includes('DLP') || log.classification);
                const isDLPBlocked = log.status === 'failed' && log.action === 'UPLOAD';
                const isLoginFailed = log.action === 'LOGIN_FAILED' || (log.action === 'LOGIN' && log.status === 'denied');
                const rowClass = isDLPBlocked ? 'bg-red-50' : isDLPScan ? 'bg-teal-50' : isLoginFailed ? 'bg-orange-50' : '';
                
                const statusColor = log.status === 'success' ? 'text-green-600 bg-green-50' :
                                  log.status === 'failed' || log.status === 'denied' ? 'text-red-600 bg-red-50' :
                                  log.status === 'warning' ? 'text-orange-600 bg-orange-50' :
                                  'text-gray-600 bg-gray-50';
                
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${rowClass}`;
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${log.timestamp}</td>
                    <td class="px-4 py-3">
                        <p class="text-sm text-gray-900">${log.user}</p>
                        <p class="text-xs text-gray-500">${log.role}</p>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${getActionIcon(log.action)}" class="w-4 h-4 ${isDLPBlocked ? 'text-red-600' : isDLPScan ? 'text-teal-600' : 'text-gray-600'}"></i>
                            <span class="text-sm text-gray-900">${log.action.replace('_', ' ')}</span>
                            ${isDLPScan ? '<span class="px-1.5 py-0.5 bg-teal-100 text-teal-700 text-xs rounded">DLP</span>' : ''}
                            ${isDLPBlocked ? '<span class="px-1.5 py-0.5 bg-red-100 text-red-700 text-xs rounded">BLOCKED</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <p class="text-sm text-gray-900">${log.resource}</p>
                        <p class="text-xs text-gray-500">${log.details}</p>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${statusColor}">
                            ${log.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <button
                                onclick="toggleHashVerification('${log.id}')"
                                class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                title="Verify Hash Chain"
                            >
                                <i data-lucide="${log.verified ? 'check-circle' : 'x-circle'}" class="w-4 h-4"></i>
                            </button>
                            <button
                                onclick='openForensicDrawer(${JSON.stringify(log).replace(/'/g, "&apos;")})'
                                class="p-1.5 text-purple-600 hover:bg-purple-50 rounded transition-colors"
                                title="Forensic Details"
                            >
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="hash-${log.id}" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded text-xs">
                            <p class="font-medium text-blue-900 mb-1">Hash Chain Verification</p>
                            <p class="text-blue-700"><span class="font-medium">Hash:</span> ${log.hash || 'N/A'}</p>
                            <p class="text-blue-700"><span class="font-medium">Prev Hash:</span> ${log.prevHash || 'N/A'}</p>
                            <p class="mt-1 font-medium ${log.verified ? 'text-green-600' : 'text-red-600'}">
                                ${log.verified ? '‚úÖ Verified - Chain Intact' : '‚ö†Ô∏è Hash verification pending'}
                            </p>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            lucide.createIcons();
        }

        // Get action icon
        function getActionIcon(action) {
            const actionUpper = (action || '').toUpperCase();
            if (actionUpper.includes('VIEW')) return 'eye';
            if (actionUpper.includes('LOGIN')) return 'log-in';
            if (actionUpper.includes('LOGOUT')) return 'log-out';
            if (actionUpper.includes('DOWNLOAD') || actionUpper.includes('EXPORT')) return 'download';
            if (actionUpper.includes('CREATE') || actionUpper.includes('ACCOUNT')) return 'user-plus';
            if (actionUpper.includes('UPDATE')) return 'edit';
            if (actionUpper.includes('DELETE')) return 'trash-2';
            if (actionUpper.includes('UPLOAD')) return 'upload';
            if (actionUpper.includes('DISPENSE')) return 'package';
            if (actionUpper.includes('SEARCH')) return 'search';
            if (actionUpper.includes('BOOK') || actionUpper.includes('APPOINTMENT')) return 'calendar';
            if (actionUpper.includes('CONSULTATION')) return 'stethoscope';
            if (actionUpper.includes('PRESCRIPTION')) return 'file-text';
            if (actionUpper.includes('DASHBOARD')) return 'layout-dashboard';
            return 'shield';
        }

        // Toggle hash verification
        function toggleHashVerification(logId) {
            const hashDiv = document.getElementById(`hash-${logId}`);
            if (currentHashVerification === logId) {
                hashDiv.classList.add('hidden');
                currentHashVerification = null;
            } else {
                if (currentHashVerification) {
                    document.getElementById(`hash-${currentHashVerification}`).classList.add('hidden');
                }
                hashDiv.classList.remove('hidden');
                currentHashVerification = logId;
            }
        }

        // Open forensic drawer
        function openForensicDrawer(log) {
            const drawer = document.getElementById('forensicDrawer');
            drawer.classList.remove('hidden');
            drawer.classList.add('flex');
            
            document.getElementById('forensic-log-id').textContent = log.id;
            
            // Basic Info
            document.getElementById('forensic-basic-info').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Event ID:</span>
                    <span class="text-gray-900 font-medium">${log.id}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Request ID:</span>
                    <span class="text-gray-900 font-mono text-xs">${log.requestId}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Session ID:</span>
                    <span class="text-gray-900 font-mono text-xs">${log.sessionId}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Timestamp:</span>
                    <span class="text-gray-900">${log.timestamp}</span>
                </div>
            `;
            
            // Device Info
            document.getElementById('forensic-device-info').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-blue-700">Device:</span>
                    <span class="text-blue-900 font-medium">${log.deviceFingerprint}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-blue-700">IP Address:</span>
                    <span class="text-blue-900 font-medium">${log.ipAddress}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-blue-700">Geo Location:</span>
                    <span class="text-blue-900 flex items-center gap-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i>
                        ${log.geoLocation}
                    </span>
                </div>
            `;
            
            // Policy Decision
            document.getElementById('forensic-policy').textContent = log.policyDecision;
            
            // Masking Applied
            document.getElementById('forensic-masking').innerHTML = log.maskingApplied
                .map(mask => `
                    <li class="text-sm text-orange-900 flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-orange-600"></div>
                        ${mask}
                    </li>
                `).join('');
            
            // Action Payload
            document.getElementById('forensic-payload').textContent = JSON.stringify(log.actionPayload, null, 2);
            
            // Hash Chain
            document.getElementById('forensic-hash').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-pink-700">Current Hash:</span>
                    <span class="text-pink-900 font-mono text-xs">${log.hash}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-pink-700">Previous Hash:</span>
                    <span class="text-pink-900 font-mono text-xs">${log.prevHash}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-pink-200">
                    <span class="text-pink-700 font-medium">Verification Status:</span>
                    <span class="font-medium ${log.verified ? 'text-green-600' : 'text-red-600'}">
                        ${log.verified ? '‚úÖ Chain Intact' : '‚ùå Chain Broken'}
                    </span>
                </div>
            `;
            
            lucide.createIcons();
        }

        // Close forensic drawer
        function closeForensicDrawer() {
            const drawer = document.getElementById('forensicDrawer');
            drawer.classList.add('hidden');
            drawer.classList.remove('flex');
        }

        // Handle export with integrity
        async function handleExportWithIntegrity() {
            try {
                // Get current filter values
                const dateRange = document.getElementById('dateRange').value;
                const actionFilter = document.getElementById('filterAction').value;
                const statusFilter = document.getElementById('filterStatus').value;
                const searchTerm = document.getElementById('searchInput').value;
                
                // Build filter description for manifest
                const filterDescription = {
                    dateRange: dateRange,
                    action: actionFilter === 'all' ? 'All Actions' : actionFilter,
                    status: statusFilter === 'all' ? 'All Status' : statusFilter,
                    securityFilter: currentSecurityFilter === 'all' ? 'All Events' : currentSecurityFilter,
                    searchTerm: searchTerm || 'None'
                };
                
                // Verify hash chain
                const verifyResponse = await fetch('/api/admin/verify-hash-chain');
                const verifyData = await verifyResponse.json();
                
                const exportData = {
                    exportInfo: {
                        exportedAt: new Date().toISOString(),
                        exportedBy: 'Admin User',
                        filtersApplied: filterDescription,
                        recordCount: allLogs.length,
                    },
                    integrityProof: {
                        chainVerified: verifyData.verified,
                        totalChainCount: verifyData.count,
                        brokenLinks: verifyData.broken_links || [],
                        verificationMessage: verifyData.message,
                        lastChainHash: allLogs.length > 0 ? allLogs[0]?.hash : 'N/A',
                        signature: 'SHA256:' + Date.now().toString(16),
                        signedBy: 'PinkHealth Security System',
                    },
                    logs: allLogs.map(log => ({
                        id: log.id,
                        timestamp: log.timestamp,
                        user: log.user,
                        role: log.role,
                        action: log.action,
                        resource: log.resource,
                        status: log.status,
                        ipAddress: log.ipAddress,
                        deviceFingerprint: log.deviceFingerprint,
                        hash: log.hash,
                        prevHash: log.prevHash,
                        verified: log.verified,
                        details: log.details,
                        policyDecision: log.policyDecision,
                        actionPayload: log.actionPayload
                    }))
                };
                
                // Generate filename with filter info
                const dateStr = new Date().toISOString().split('T')[0];
                const filterSuffix = currentSecurityFilter !== 'all' ? `-${currentSecurityFilter}` : '';
                const filename = `audit-logs-${dateRange}${filterSuffix}-${dateStr}.json`;
                
                // Download as JSON file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast(`Exported ${allLogs.length} logs (${dateRange}, ${filterDescription.securityFilter}) - Chain ${verifyData.verified ? 'Verified ‚úì' : 'Issues Found'}`);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export audit logs');
            }
        }

        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Initialize on page load
        init();
    </script>
{% endblock %}