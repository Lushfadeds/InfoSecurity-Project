{% extends "base.html" %}

{% block title %}PinkHealth - Secure Chat{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="flex">
    {% if role == 'patient' %}
        {% include 'includes/patient-sidebar.html' %}
    {% endif %}

    {% if role == 'doctor' %}
        {% include 'includes/doctor-sidebar.html' %}
    {% endif %}

    {% if role == 'admin' %}
        {% include 'includes/admin-navbar.html' %}
    {% endif %}

    <!-- Main Chat Container -->
    <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid lg:grid-cols-4 gap-6" style="height: 800px;">
            
            <!-- Conversations List -->
            <div class="lg:col-span-1 bg-white rounded-xl border border-gray-200 shadow-md overflow-hidden flex flex-col">
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Conversations</h2>
                    <input type="text" placeholder="Search conversations..." 
                                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-pink-500">
                </div>
                
                <div class="overflow-y-auto flex-1">
                    {% if conversations and conversations|length > 0 %}
                        {% for conv in conversations %}
                        <a href="{{ url_for('chat.chat_room', room_id=conv.room_id) }}" class="block p-3 border-b border-gray-100 hover:bg-pink-50 transition cursor-pointer">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-pink-600 font-semibold text-sm">{{ conv.recipient_name[0] }}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900 truncate">{{ conv.recipient_name }}</h3>
                                    <p class="text-xs text-gray-500 truncate">{{ conv.last_message }}</p>
                                    <span class="text-xs text-gray-400">{{ conv.timestamp }}</span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="p-6 text-center text-gray-500">
                            <p class="text-sm">No conversations yet</p>
                            <p class="text-xs text-gray-400 mt-1">Start a new conversation</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Chat Window -->
            <div class="lg:col-span-3 bg-white rounded-xl border border-gray-200 shadow-md overflow-hidden flex flex-col">
                
                <!-- Chat Header -->
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-white flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center">
                            <span class="text-pink-600 font-semibold">{{ recipient_name.data[0].full_name[0] if recipient_name.data else "U" }}</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">{{ recipient_name.data[0].full_name if recipient_name.data else "Unknown" }}</h2>
                            <p class="text-xs text-gray-500">{{ recipient_name.data[0].role if recipient_name.data else "Unknown" }}</p>
                        </div>
                    </div>
                    <!-- Blur toggle button -->
                    <button id="blur-toggle-btn" title="Toggle privacy screen"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 text-xs text-gray-500 hover:bg-gray-100 transition">
                        <svg id="blur-icon-on" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <svg id="blur-icon-off" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                        </svg>
                        <span id="blur-label">Hide</span>
                    </button>
                </div>

                <!-- Messages -->
                <div id="message-container" class="relative flex-1 overflow-y-auto p-6 bg-gray-50 space-y-4">
                    <!-- Blur overlay ‚Äî shown when blurred -->
                    <div id="blur-overlay" class="hidden absolute inset-0 z-10 flex flex-col items-center justify-center cursor-pointer"
                         style="backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background: rgba(249,250,251,0.4);">
                        <div class="bg-white rounded-xl shadow-lg px-6 py-5 flex flex-col items-center gap-2 border border-pink-100">
                            <svg class="w-8 h-8 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                            </svg>
                            <p class="text-sm font-semibold text-gray-700">Messages hidden</p>
                            <p class="text-xs text-gray-400">Click anywhere or press <kbd class="px-1 py-0.5 bg-gray-100 rounded text-gray-600 font-mono">H</kbd> to reveal</p>
                        </div>
                    </div>

                    <!-- Ephemeral session notice -->
                    <div id="ephemeral-notice" class="flex flex-col items-center justify-center py-8 text-center">
                        <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center mb-3">
                            <svg class="w-6 h-6 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">End-to-End Encrypted</p>
                        <p class="text-xs text-gray-400 mt-1 max-w-xs">
                            Messages are encrypted on your device and visible only during this session.
                            History is not stored to protect your privacy.
                        </p>
                        <div class="mt-3 px-3 py-1 bg-pink-50 border border-pink-200 rounded-full">
                            <span class="text-xs text-pink-600 font-medium">üîí This conversation is private</span>
                        </div>
                    </div>
                    <div id="messages"></div>
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t border-gray-200 bg-white">
                    <div class="flex gap-3 items-center">
                        <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-500 text-sm">
                        <button id="send-btn" type="button" class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition font-medium text-sm" disabled>
                            Send
                        </button>
                        <span id="e2ee-status" class="text-xs text-gray-400 ml-2">üîí Not ready</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
  </div>
</div>

<!-- PII Warning Modal -->
<div id="pii-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <div class="flex items-center gap-3 mb-3">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <h3 class="font-semibold text-gray-900">Sensitive Information Detected</h3>
        </div>
        <p id="pii-warning-text" class="text-sm text-gray-600 mb-4"></p>
        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 mb-4">
            <p class="text-xs text-gray-500 font-medium mb-1">REDACTED VERSION</p>
            <p id="pii-redacted-text" class="text-sm text-gray-800 font-mono break-all"></p>
        </div>
        <div class="flex gap-2">
            <button id="pii-send-redacted" class="flex-1 px-4 py-2 bg-pink-500 text-white rounded-lg text-sm font-medium hover:bg-pink-600 transition">
                Send Redacted
            </button>
            <button id="pii-send-anyway" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition">
                Send Anyway
            </button>
            <button id="pii-cancel" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='chat/crypto_utils.js') }}"></script>
<script type="text/javascript">
    const ROOM_ID = {{ room|tojson }};
    const USER_NAME = {{ user_name|tojson }};
    const USER_ID = {{ user_id|tojson }};

    // E2EE variables
    let myKeyPair = null;
    let sharedAESKey = null;
    let theirPublicKey = null;

    // Track if we've sent our public key in response to a peer
    let sentPublicKeyTo = {};

    // Utility: base64 encode/decode ArrayBuffer
    function ab2b64(buf) {
        return btoa(String.fromCharCode(...new Uint8Array(buf)));
    }
    function b642ab(b64) {
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    // Helper to update E2EE status UI
    function setE2EEReady(ready) {
        if (ready) {
            $("#send-btn").prop("disabled", false);
            $("#e2ee-status").text("üîí Secure");
            $("#e2ee-status").removeClass("text-gray-400").addClass("text-green-600");
        } else {
            $("#send-btn").prop("disabled", true);
            $("#e2ee-status").text("üîí Not ready");
            $("#e2ee-status").removeClass("text-green-600").addClass("text-gray-400");
        }
    }

    $(document).ready(function() {
        var socket = io();

        setE2EEReady(false); // Initially not ready

        // --- E2EE: Generate key pair and exchange public keys ---
        (async function setupE2EE() {
            myKeyPair = await generateKeyPairs();
            // Export and send public key to room
            const exported = await exportPublicKey(myKeyPair.publicKey);
            socket.emit("exchange_public_key", {
                room_id: ROOM_ID,
                public_key: ab2b64(exported)
            });
        })();

        // Receive other's public key and derive shared key
        socket.on("public_key", async function(data) {
            if (String(data.sender_id) === String(USER_ID)) return; // Ignore own

            // Respond with our public key if we haven't already sent it to this sender
            if (!sentPublicKeyTo[data.sender_id]) {
                const exported = await exportPublicKey(myKeyPair.publicKey);
                socket.emit("exchange_public_key", {
                    room_id: ROOM_ID,
                    public_key: ab2b64(exported)
                });
                sentPublicKeyTo[data.sender_id] = true;
            }

            theirPublicKey = await importPublicKey(b642ab(data.public_key));
            sharedAESKey = await deriveSharedAESKey(myKeyPair.privateKey, theirPublicKey);
            setE2EEReady(true); // Now encryption is ready
        });

        // =========================
        // CONNECT
        // =========================
        socket.on("connect", function() {
            console.log("Connected to chat server");
            console.log("Joining room: " + ROOM_ID);
            // join the chat room
            socket.emit("join_room", {
                room_id: ROOM_ID
            });
        });

        // =========================
        // RECEIVE MESSAGE
        // =========================
        socket.on("receive_message", async function(data) {
            // Hide the ephemeral notice once real messages appear
            $("#ephemeral-notice").hide();

            const isMine = String(data.sender_id) === String(USER_ID);
            let displayText = data.text;
            if (sharedAESKey && data.iv) {
                try {
                    displayText = await decryptMessage(
                        b642ab(data.text),
                        b642ab(data.iv),
                        sharedAESKey
                    );
                } catch (e) {
                    displayText = "[Unable to decrypt]";
                }
            }
            const msgDiv = $("<div>").addClass(isMine ? "sent" : "received");

            // Use data.timestamp for consistency
            let displayTime = "";
            if (data.timestamp) {
                // Remove 'Z', replace 'T' with space, show up to minutes
                displayTime = data.timestamp.replace('T', ' ').replace('Z', '').slice(0, 16);
            }

            msgDiv.append(
                $("<strong>").text(data.fullname + ": " + displayTime),
                $("<p>").text(displayText),
            );

            $("#messages").append(msgDiv);
            scrollToBottom();
        });

        // =========================
        // STATUS (join/leave)
        // =========================
        socket.on("status", function(data) {
            $("#messages").append(
                $("<div>").addClass("text-center text-gray-400 text-sm").text(data.msg)
            );
        });

        // =========================
        // SEND MESSAGE (encrypt before sending)
        // =========================
        $("#send-btn").click(sendMessage);
        $("#chat-input").keypress(function(e){
            if(e.which === 13) sendMessage();
        });

        // PII modal state
        let pendingPlaintext = null;
        let pendingRedacted  = null;

        async function sendMessage() {
            const text = $("#chat-input").val().trim();
            if (!text) return;
            if (!sharedAESKey) {
                alert("Encryption not ready. Please wait for secure connection.");
                return;
            }

            // PII check before encrypting
            try {
                const res  = await fetch("/chat/check_pii", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token() }}"
                    },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();

                if (data.has_pii) {
                    pendingPlaintext = text;
                    pendingRedacted  = data.redacted;
                    $("#pii-warning-text").text(data.warning);
                    $("#pii-redacted-text").text(data.redacted);
                    $("#pii-modal").removeClass("hidden");
                    return; // pause ‚Äî wait for user decision
                }
            } catch (e) {
                // PII service unavailable ‚Äî allow send
                console.warn("PII check unavailable:", e);
            }

            await encryptAndSend(text);
            $("#chat-input").val("");
        }

        async function encryptAndSend(text) {
            const { ciphertext, iv } = await encryptMessage(text, sharedAESKey);
            socket.emit("send_message", {
                room_id: ROOM_ID,
                text: ab2b64(ciphertext),
                iv: ab2b64(iv)
            });
        }

        // Modal button handlers
        $("#pii-send-redacted").click(async function() {
            $("#pii-modal").addClass("hidden");
            await encryptAndSend(pendingRedacted);
            $("#chat-input").val("");
        });

        $("#pii-send-anyway").click(async function() {
            $("#pii-modal").addClass("hidden");
            await encryptAndSend(pendingPlaintext);
            $("#chat-input").val("");
        });

        $("#pii-cancel").click(function() {
            $("#pii-modal").addClass("hidden");
        });

        function scrollToBottom(){
            const container = document.getElementById("message-container");
            container.scrollTop = container.scrollHeight;
        }

        // ‚îÄ‚îÄ Shoulder-surf protection: blur toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let isBlurred = false;

        function setBlur(blur) {
            isBlurred = blur;
            const overlay  = $("#blur-overlay");
            const iconOn   = $("#blur-icon-on");   // eye (visible state)
            const iconOff  = $("#blur-icon-off");  // eye-off (hidden state)
            const label    = $("#blur-label");

            if (blur) {
                overlay.removeClass("hidden");
                iconOn.addClass("hidden");
                iconOff.removeClass("hidden");
                label.text("Show");
            } else {
                overlay.addClass("hidden");
                iconOn.removeClass("hidden");
                iconOff.addClass("hidden");
                label.text("Hide");
            }
        }

        // Manual toggle button
        $("#blur-toggle-btn").click(function() {
            setBlur(!isBlurred);
        });

        // Click overlay to unblur
        $("#blur-overlay").click(function() {
            setBlur(false);
        });

        // Keyboard shortcut: H to toggle
        $(document).keydown(function(e) {
            // Don't trigger when typing in the input
            if (e.target.id === "chat-input") return;
            if (e.key === "h" || e.key === "H") setBlur(!isBlurred);
        });

        // Auto-blur when tab loses focus (user switches window/tab)
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                setBlur(true);   // tab hidden ‚Üí blur immediately
            }
            // Note: we don't auto-unblur on return ‚Äî user must do it manually
        });

        window.addEventListener("blur", function() {
            // Window lost focus (e.g. alt-tab) ‚Äî blur as extra safety net
            setBlur(true);
        });

        // ‚îÄ‚îÄ Emit leave_room on navigation away or tab close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // This is what triggers server-side message deletion when both users leave.
        // Uses sendBeacon for reliability on tab close (fetch/XHR are cancelled).
        function leaveRoom() {
            socket.emit("leave_room", { room_id: ROOM_ID });
        }

        // Tab/browser close or page refresh
        window.addEventListener("beforeunload", leaveRoom);

        // Navigating to another page within the app (e.g. clicking sidebar)
        // beforeunload covers this too, but socket.on disconnect is a safety net
        socket.on("disconnect", function() {
            // Socket already disconnected ‚Äî server will handle cleanup
            // via the occupancy tracker on the next join
        });

    });
</script>
{% endblock %}

{% block extra_styles %}
<style>
    #messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
</style>
{% endblock %}