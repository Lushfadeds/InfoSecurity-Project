{% extends "base.html" %}

{% block title %}PinkHealth - Secure Chat{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="flex">
    {% if role == 'patient' %}
        {% include 'includes/patient-sidebar.html' %}
    {% endif %}

    {% if role == 'doctor' %}
        {% include 'includes/doctor-sidebar.html' %}
    {% endif %}

    {% if role == 'admin' %}
        {% include 'includes/admin-navbar.html' %}
    {% endif %}

    <!-- Main Chat Container -->
    <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid lg:grid-cols-4 gap-6" style="height: 800px;">
            
            <!-- Conversations List -->
            <div class="lg:col-span-1 bg-white rounded-xl border border-gray-200 shadow-md overflow-hidden flex flex-col">
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Conversations</h2>
                    <input type="text" placeholder="Search conversations..." 
                                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-pink-500">
                </div>
                
                <div class="overflow-y-auto flex-1">
                    {% if conversations and conversations|length > 0 %}
                        {% for conv in conversations %}
                        <a href="{{ url_for('chat.chat_room', room_id=conv.room_id) }}" class="block p-3 border-b border-gray-100 hover:bg-pink-50 transition cursor-pointer">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-pink-600 font-semibold text-sm">{{ conv.recipient_name[0] }}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900 truncate">{{ conv.recipient_name }}</h3>
                                    <p class="text-xs text-gray-500 truncate">{{ conv.last_message }}</p>
                                    <span class="text-xs text-gray-400">{{ conv.timestamp }}</span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="p-6 text-center text-gray-500">
                            <p class="text-sm">No conversations yet</p>
                            <p class="text-xs text-gray-400 mt-1">Start a new conversation</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Chat Window -->
            <div class="lg:col-span-3 bg-white rounded-xl border border-gray-200 shadow-md overflow-hidden flex flex-col">
                
                <!-- Chat Header -->
                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-white flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center">
                            <span class="text-pink-600 font-semibold">{{ recipient_name.data[0].full_name[0] if recipient_name.data else "U" }}</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">{{ recipient_name.data[0].full_name if recipient_name.data else "Unknown" }}</h2>
                            <p class="text-xs text-gray-500">{{ recipient_name.data[0].role if recipient_name.data else "Unknown" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="message-container" class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-4">
                    <div id="messages">
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t border-gray-200 bg-white">
                    <div class="flex gap-3 items-center">
                        <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-500 text-sm">
                        <button id="send-btn" type="button" class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition font-medium text-sm" disabled>
                            Send
                        </button>
                        <span id="e2ee-status" class="text-xs text-gray-400 ml-2">ðŸ”’ Not ready</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='chat/crypto_utils.js') }}"></script>
<script type="text/javascript">
    const ROOM_ID = {{ room|tojson }};
    const USER_NAME = {{ user_name|tojson }};
    const USER_ID = {{ user_id|tojson }};

    // E2EE variables
    let myKeyPair = null;
    let sharedAESKey = null;
    let theirPublicKey = null;

    // Track if we've sent our public key in response to a peer
    let sentPublicKeyTo = {};

    // Utility: base64 encode/decode ArrayBuffer
    function ab2b64(buf) {
        return btoa(String.fromCharCode(...new Uint8Array(buf)));
    }
    function b642ab(b64) {
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    // Helper to update E2EE status UI
    function setE2EEReady(ready) {
        if (ready) {
            $("#send-btn").prop("disabled", false);
            $("#e2ee-status").text("ðŸ”’ Secure");
            $("#e2ee-status").removeClass("text-gray-400").addClass("text-green-600");
        } else {
            $("#send-btn").prop("disabled", true);
            $("#e2ee-status").text("ðŸ”’ Not ready");
            $("#e2ee-status").removeClass("text-green-600").addClass("text-gray-400");
        }
    }

    $(document).ready(function() {
        var socket = io();

        setE2EEReady(false); // Initially not ready

        // --- E2EE: Generate key pair and exchange public keys ---
        (async function setupE2EE() {
            myKeyPair = await generateKeyPairs();
            // Export and send public key to room
            const exported = await exportPublicKey(myKeyPair.publicKey);
            socket.emit("exchange_public_key", {
                room_id: ROOM_ID,
                public_key: ab2b64(exported)
            });
        })();

        // Receive other's public key and derive shared key
        socket.on("public_key", async function(data) {
            if (String(data.sender_id) === String(USER_ID)) return; // Ignore own

            // Respond with our public key if we haven't already sent it to this sender
            if (!sentPublicKeyTo[data.sender_id]) {
                const exported = await exportPublicKey(myKeyPair.publicKey);
                socket.emit("exchange_public_key", {
                    room_id: ROOM_ID,
                    public_key: ab2b64(exported)
                });
                sentPublicKeyTo[data.sender_id] = true;
            }

            theirPublicKey = await importPublicKey(b642ab(data.public_key));
            sharedAESKey = await deriveSharedAESKey(myKeyPair.privateKey, theirPublicKey);
            setE2EEReady(true); // Now encryption is ready
        });

        // =========================
        // CONNECT
        // =========================
        socket.on("connect", function() {
            console.log("Connected to chat server");
            console.log("Joining room: " + ROOM_ID);
            // join the chat room
            socket.emit("join_room", {
                room_id: ROOM_ID
            });
        });

        // =========================
        // RECEIVE MESSAGE
        // =========================
        socket.on("receive_message", async function(data) {
            const isMine = String(data.sender_id) === String(USER_ID);
            let displayText = data.text;
            if (sharedAESKey && data.iv) {
                try {
                    displayText = await decryptMessage(
                        b642ab(data.text),
                        b642ab(data.iv),
                        sharedAESKey
                    );
                } catch (e) {
                    displayText = "[Unable to decrypt]";
                }
            }
            const msgDiv = $("<div>").addClass(isMine ? "sent" : "received");

            // Use data.timestamp for consistency
            let displayTime = "";
            if (data.timestamp) {
                // Remove 'Z', replace 'T' with space, show up to minutes
                displayTime = data.timestamp.replace('T', ' ').replace('Z', '').slice(0, 16);
            }

            msgDiv.append(
                $("<strong>").text(data.fullname + ": " + displayTime),
                $("<p>").text(displayText),
            );

            $("#messages").append(msgDiv);
            scrollToBottom();
        });

        // =========================
        // STATUS (join/leave)
        // =========================
        socket.on("status", function(data) {
            $("#messages").append(
                $("<div>").addClass("text-center text-gray-400 text-sm").text(data.msg)
            );
        });

        // =========================
        // SEND MESSAGE (encrypt before sending)
        // =========================
        $("#send-btn").click(sendMessage);
        $("#chat-input").keypress(function(e){
            if(e.which === 13) sendMessage();
        });

        async function sendMessage() {
            const text = $("#chat-input").val().trim();
            if(!text) return;
            if(!sharedAESKey) {
                alert("Encryption not ready. Please wait for secure connection.");
                return;
            }
            // Encrypt message
            const {ciphertext, iv} = await encryptMessage(text, sharedAESKey);
            socket.emit("send_message", {
                room_id: ROOM_ID,
                text: ab2b64(ciphertext),
                iv: ab2b64(iv)
            });
            $("#chat-input").val("");
        }

        function scrollToBottom(){
            const container = document.getElementById("message-container");
            container.scrollTop = container.scrollHeight;
        }

    });
</script>
{% endblock %}

{% block extra_styles %}
<style>
    #messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
</style>
{% endblock %}