{% extends 'base.html' %}

{% block title %}Consultation - PinkHealth Doctor Portal{% endblock %}

{% block content %}
<style>
    .h1 { font-size: 2rem; font-weight: 700; }
    .h2 { font-size: 1.25rem; font-weight: 600; }
    .h3 { font-size: 1rem; font-weight: 600; }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
</style>

<div class="bg-gray-50">
    <div class="flex">
        {% set active_page = 'consultation' %}
        <!-- Sidebar -->
        {% include 'doctor/includes/doctor-navbar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-4 lg:p-8">
            <div class="max-w-5xl">
                <h1 class="text-gray-900 mb-6 h1">Consultation</h1>

                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Patient Information -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="text-gray-900 mb-4 h2">Patient Information</h2>
                            <div class="grid sm:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600 mb-1">Patient Name</p>
                                    <p class="text-gray-900">John Doe</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1">NRIC</p>
                                    <p class="text-gray-900">S****123A</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1">Age / Gender</p>
                                    <p class="text-gray-900">34 years / Male</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1">Contact</p>
                                    <p class="text-gray-900">+65 9123 4567</p>
                                </div>
                            </div>
                        </div>

                        <!-- Consultation Notes -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="text-gray-900 mb-4 h2">Consultation Notes</h2>
                            <div class="space-y-4">
                                <!-- Diagnosis -->
                                <div>
                                    <label class="block text-gray-700 text-sm mb-2">Diagnosis *</label>
                                    <input
                                        id="diagnosis"
                                        type="text"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., Acute Upper Respiratory Tract Infection"
                                    />
                                </div>

                                <!-- Clinical Notes -->
                                <div>
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="block text-gray-700 text-sm">Clinical Notes *</label>
                                        <button onclick="togglePhiAnalysis()" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700">
                                            <i data-lucide="eye" class="w-3 h-3"></i>
                                            <span id="phiToggleText">Show</span> PHI Analysis
                                        </button>
                                    </div>
                                    <textarea
                                        id="notes"
                                        oninput="updatePhiAnalysis()"
                                        rows="6"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Patient presents with symptoms of... Examination reveals..."
                                    ></textarea>
                                    <div class="flex items-center justify-between mt-1">
                                        <p class="text-xs text-gray-500">ðŸ”’ Notes will be encrypted upon saving</p>
                                        <div id="phiRiskIndicator" class="hidden flex items-center gap-2">
                                            <span id="phiRiskLevel" class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">
                                                Risk: low
                                            </span>
                                            <span id="phiMatchCount" class="text-xs text-gray-500">0 PHI detected</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- PHI Analysis Panel -->
                                <div id="phiPanel" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2">
                                        <i data-lucide="alert-circle" class="w-4 h-4 text-blue-600 mt-0.5"></i>
                                        <div class="flex-1">
                                            <p class="text-xs text-blue-900 mb-2">
                                                <strong>NLP-Powered PHI Detection:</strong> Real-time analysis of sensitive medical information
                                            </p>
                                            <div id="phiTypesList" class="flex flex-wrap gap-1 mb-2"></div>
                                            <div id="phiMatchesList" class="space-y-2"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Treatment Plan -->
                                <div>
                                    <label class="block text-gray-700 text-sm mb-2">Treatment Plan</label>
                                    <textarea
                                        id="treatmentPlan"
                                        rows="4"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Prescribed medications, follow-up instructions..."
                                    ></textarea>
                                </div>

                                <!-- Document Upload -->
                                <div>
                                    <label class="block text-gray-700 text-sm mb-2 flex items-center gap-2">
                                        Upload Related Documents
                                        <i data-lucide="shield" class="w-4 h-4 text-blue-600" title="DLP-Protected Upload"></i>
                                    </label>
                                    
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-400 transition-colors text-center">
                                        <i data-lucide="upload" class="w-10 h-10 text-gray-400 mx-auto mb-3"></i>
                                        <p class="text-sm text-gray-700 mb-1">Drop lab results, X-rays, or reports here</p>
                                        <p class="text-xs text-gray-500 mb-3">PDF, JPG, PNG accepted â€¢ DLP scanning enabled</p>
                                        <input
                                            type="file"
                                            id="fileInput"
                                            accept=".pdf,.jpg,.jpeg,.png"
                                            onchange="handleFileUpload(event)"
                                            class="hidden"
                                        />
                                        <label for="fileInput" class="inline-block px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 cursor-pointer text-sm">
                                            Select File
                                        </label>
                                    </div>

                                    <!-- Scan Results Container -->
                                    <div id="scanResults"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button onclick="handleCancel()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                            <button onclick="handleSaveConsultation()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="save" class="w-5 h-5"></i>
                                Save Consultation
                            </button>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="space-y-6">
                        <!-- Quick Actions -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h3 class="text-gray-900 mb-4 h3">Quick Actions</h3>
                            <div class="space-y-2">
                                <a href="/doctor/write-mc" class="block px-4 py-2 text-center bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm font-medium">
                                    Issue MC
                                </a>
                                <a href="/doctor/write-prescription" class="block px-4 py-2 text-center bg-pink-50 text-pink-700 rounded-lg hover:bg-pink-100 transition-colors text-sm font-medium">
                                    Write Prescription
                                </a>
                            </div>
                        </div>

                        <!-- Previous Visits -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h3 class="text-gray-900 mb-4 h3">Previous Visits</h3>
                            <div class="space-y-3 text-sm">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-gray-900 mb-1">Dec 10, 2023</p>
                                    <p class="text-gray-600">Annual checkup</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-gray-900 mb-1">Jun 15, 2023</p>
                                    <p class="text-gray-600">Flu symptoms</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg hidden transform transition-all duration-300 text-white"
     style="background-color: #10b981;">
    <p id="toastMessage"></p>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
        lucide.createIcons();
        let phiPanelVisible = false;

        function togglePhiAnalysis() {
            phiPanelVisible = !phiPanelVisible;
            const panel = document.getElementById('phiPanel');
            const toggleText = document.getElementById('phiToggleText');
            
            if (phiPanelVisible) {
                panel.classList.remove('hidden');
                toggleText.textContent = 'Hide';
            } else {
                panel.classList.add('hidden');
                toggleText.textContent = 'Show';
            }
        }

        function updatePhiAnalysis() {
            const notes = document.getElementById('notes').value;
            const riskIndicator = document.getElementById('phiRiskIndicator');
            
            if (notes.length > 10) {
                riskIndicator.classList.remove('hidden');
                // Simulate PHI detection - in real app would call detectPHIInText()
                const hasHighRisk = notes.includes('S8') || notes.includes('HIV') || notes.includes('cancer');
                const riskLevel = document.getElementById('phiRiskLevel');
                
                if (hasHighRisk) {
                    riskLevel.textContent = 'Risk: high';
                    riskLevel.className = 'text-xs px-2 py-0.5 rounded bg-red-100 text-red-700';
                } else {
                    riskLevel.textContent = 'Risk: low';
                    riskLevel.className = 'text-xs px-2 py-0.5 rounded bg-green-100 text-green-700';
                }
            } else {
                riskIndicator.classList.add('hidden');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files?.[0];
            if (!file) return;

            const resultsDiv = document.getElementById('scanResults');
            const isBlocked = Math.random() > 0.6; // Simulate block/pass
            
            if (isBlocked) {
                resultsDiv.innerHTML = `
                    <div class="mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                        <div class="flex items-start gap-3 mb-3">
                            <div class="p-2 bg-red-500 rounded-lg">
                                <i data-lucide="x-circle" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-red-900 font-medium mb-1">ðŸš« Upload Blocked by DLP</h4>
                                <p class="text-sm text-red-800 mb-2">This file contains sensitive data that violates DLP policies.</p>
                                <p class="text-xs text-red-700">Upload prevented and logged in immutable audit trail.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="mt-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                        <div class="flex items-start gap-3">
                            <div class="p-2 bg-green-500 rounded-lg">
                                <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-green-900 font-medium mb-1">âœ… DLP Scan Passed</h4>
                                <p class="text-sm text-green-800 mb-2">File cleared. No sensitive patterns detected.</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <i data-lucide="file-text" class="w-4 h-4 text-green-700"></i>
                                    <span class="text-xs text-green-700">${file.name}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function handleSaveConsultation() {
            const diagnosis = document.getElementById('diagnosis').value;
            const notes = document.getElementById('notes').value;
            
            if (!diagnosis.trim() || !notes.trim()) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            showToast('Consultation saved successfully. All data has been encrypted and logged securely.', 'success');
            
            // Reset form
            document.getElementById('diagnosis').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('treatmentPlan').value = '';
            document.getElementById('scanResults').innerHTML = '';
        }

        function handleCancel() {
            window.location.href = '/doctor/patient-lookup';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            } else {
                toast.style.backgroundColor = '#10b981';
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
{% endblock %}